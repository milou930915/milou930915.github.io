<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜åˆ†å­æ´¾å° (ä¸€éµé€£ç·š)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    
    <style>
        /* === ğŸ¨ é¢¨æ ¼è¨­å®š === */
        :root {
            --bg-color: #E0F7FA;
            --red: #FF6B6B; --blue: #4D96FF; --green: #6BCB77; --yellow: #FFD93D; --purple: #9A67EA;
            --text-color: #444;
        }
        body {
            font-family: 'Varela Round', sans-serif; margin: 0; background-color: var(--bg-color);
            background-image: radial-gradient(#B2EBF2 15%, transparent 16%), radial-gradient(#B2EBF2 15%, transparent 16%);
            background-size: 60px 60px; background-position: 0 0, 30px 30px;
            color: var(--text-color); overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }
        .btn {
            border: none; outline: none; cursor: pointer; font-family: 'Varela Round', sans-serif; font-weight: bold;
            border-radius: 20px; transition: all 0.1s; box-shadow: 0 6px 0 rgba(0,0,0,0.2);
            text-transform: uppercase; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.2); }

        /* 1. èµ·å§‹é  */
        #start-screen {
            position: absolute; width: 100%; height: 100%; z-index: 100;
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 40px;
        }
        .logo {
            background: white; padding: 20px 40px; border-radius: 30px;
            font-size: 3.5rem; color: var(--blue); box-shadow: 0 10px 20px rgba(0,0,0,0.2); transform: rotate(-3deg);
        }
        /* è¶…å¤§æŒ‰éˆ• */
        .role-btn { width: 80%; max-width: 300px; padding: 25px; font-size: 1.5rem; color: white; }

        /* 2. é›»è…¦ä»‹é¢ */
        #teacher-ui { display: none; width: 100%; height: 100%; flex-direction: column; }
        .hud {
            height: 12%; display: flex; justify-content: center; gap: 20px; align-items: center;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
        }
        .score-card {
            background: white; padding: 10px 25px; border-radius: 50px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 0 #ddd; border: 3px solid transparent; transition: 0.3s;
        }
        .score-card.active { transform: scale(1.1) translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-color: currentColor;}

        .board-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 10px; }
        .board { display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(5, 1fr); gap: 12px; width: 95%; height: 85%; max-width: 1400px; }

        .cell {
            background: white; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold; color: #ccc; box-shadow: 0 5px 0 #cbd5e1; position: relative; border: 2px solid #ecf0f1;
        }
        .cell.Start { background: #FFD3B6; color: #ff6b6b; border: none;}
        .cell.Finish { background: #FFD93D; color: #d35400; border: 3px solid #ff9f43;}
        
        .token {
            width: 50px; height: 50px; border-radius: 50%; position: absolute; z-index: 10;
            background: white; border: 3px solid white; box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center; font-size: 2rem;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer;
        }
        .token:hover { transform: scale(1.2); }

        /* 3. æ‰‹æ©Ÿä»‹é¢ */
        #student-ui { display: none; width: 100%; height: 100%; flex-direction: column; background: #f0f2f5; }
        .mobile-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        
        .pad-msg { font-size: 2rem; color: #333; margin-bottom: 30px; font-weight: bold; text-align:center;}
        .big-action-btn { width: 250px; height: 250px; border-radius: 50%; font-size: 3rem; background: var(--yellow); color: #8a6d0b; box-shadow: 0 15px 0 #d4b106; }
        .big-action-btn:active { transform: translateY(15px); box-shadow: 0 0 0 #d4b106; }
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .ans-btn { height: 100px; font-size: 2rem; color: white; border-radius: 20px; }

        /* å½ˆçª— */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal-card { background: white; width: 90%; max-width: 650px; padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: bounceIn 0.4s; }
        @keyframes bounceIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        .opt-row { background: #f8f9fa; padding: 20px; margin: 10px 0; border-radius: 15px; text-align: left; font-size: 1.3rem; border: 3px solid transparent; cursor: pointer; }
        .opt-row.correct { background: #e8f5e9; border-color: var(--green); color: var(--green); font-weight: bold;}
        .opt-row.wrong { background: #ffebee; border-color: var(--red); color: var(--red); }
        .event-icon { font-size: 5rem; margin-bottom: 20px; animation: pop 0.5s; display: block;}
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        /* ç­‰å¾…ç•«é¢ */
        #conn-status { color: white; margin-top: 20px; font-size: 1.2rem; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(name) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            if(name==='roll'){osc.type='triangle';osc.frequency.setValueAtTime(200,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);osc.start();osc.stop(audioCtx.currentTime+0.2);}
            if(name==='win'){osc.type='sine';osc.frequency.setValueAtTime(400,audioCtx.currentTime);g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.5);osc.start();osc.stop(audioCtx.currentTime+0.5);}
            if(name==='fail'){osc.type='sawtooth';osc.frequency.setValueAtTime(150,audioCtx.currentTime);g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);osc.start();osc.stop(audioCtx.currentTime+0.3);}
        }
    </script>

    <div id="start-screen">
        <div class="logo">ğŸ§ª é«˜åˆ†å­æ´¾å°</div>
        
        <button class="btn role-btn" style="background:var(--blue);" onclick="startTeacher()">
            ğŸ’» é›»è…¦ç«¯ (å»ºç«‹)
        </button>
        
        <button class="btn role-btn" style="background:white; color:var(--blue);" onclick="joinGameAuto()">
            ğŸ“± æ‰‹æ©Ÿç«¯ (åŠ å…¥)
        </button>
        
        <div id="conn-status" style="display:none;">æ­£åœ¨é€£ç·š...</div>
    </div>

    <div id="teacher-ui">
        <div class="hud">
            <div id="card-0" class="score-card" style="color:var(--red)"><span>ğŸ¯ ç¬¬ä¸€çµ„</span> <span id="s1">0</span></div>
            <div id="card-1" class="score-card" style="color:var(--blue)"><span>ğŸ³ ç¬¬äºŒçµ„</span> <span id="s2">0</span></div>
            <div id="card-2" class="score-card" style="color:var(--green)"><span>ğŸ¸ ç¬¬ä¸‰çµ„</span> <span id="s3">0</span></div>
            <div id="card-3" class="score-card" style="color:var(--yellow)"><span>ğŸ¦ ç¬¬äº”çµ„</span> <span id="s4">0</span></div>
            <div style="margin-left:auto; color:#888; font-weight:bold;" id="host-status">ç­‰å¾…æ‰‹æ©Ÿ...</div>
        </div>
        <div class="board-container"><div class="board" id="board"></div></div>
    </div>

    <div id="student-ui">
        <div id="team-select-screen" class="mobile-center">
            <h2 style="color:var(--blue); margin-top:0;">è«‹é¸æ“‡çµ„åˆ¥</h2>
            <div class="team-grid">
                <button class="btn" style="background:var(--red); color:white; padding:30px;" onclick="setTeam(0)">ğŸ¯ ç¬¬ä¸€çµ„</button>
                <button class="btn" style="background:var(--blue); color:white; padding:30px;" onclick="setTeam(1)">ğŸ³ ç¬¬äºŒçµ„</button>
                <button class="btn" style="background:var(--green); color:white; padding:30px;" onclick="setTeam(2)">ğŸ¸ ç¬¬ä¸‰çµ„</button>
                <button class="btn" style="background:var(--yellow); color:black; padding:30px;" onclick="setTeam(3)">ğŸ¦ ç¬¬äº”çµ„</button>
            </div>
        </div>
        <div id="pad-screen" class="mobile-center" style="display:none;">
            <div id="pad-msg" class="pad-msg">ç­‰å¾…ä¸­...</div>
            <div id="pad-dice" style="display:none;"><button class="btn big-action-btn" onclick="sendCmd('ROLL')">ğŸ²</button></div>
            <div id="pad-quiz" style="display:none; width:100%; justify-content:center;">
                <div class="ans-grid">
                    <button class="btn ans-btn" style="background:var(--red)" onclick="sendCmd('ANS',0)">A</button>
                    <button class="btn ans-btn" style="background:var(--blue)" onclick="sendCmd('ANS',1)">B</button>
                    <button class="btn ans-btn" style="background:var(--green)" onclick="sendCmd('ANS',2)">C</button>
                    <button class="btn ans-btn" style="background:var(--yellow); color:black" onclick="sendCmd('ANS',3)">D</button>
                </div>
            </div>
            <div id="pad-target" style="display:none; width:100%; justify-content:center;">
                <div class="ans-grid">
                    <button class="btn ans-btn" style="background:var(--red)" onclick="sendCmd('TARGET',0)">ä¸€</button>
                    <button class="btn ans-btn" style="background:var(--blue)" onclick="sendCmd('TARGET',1)">äºŒ</button>
                    <button class="btn ans-btn" style="background:var(--green)" onclick="sendCmd('TARGET',2)">ä¸‰</button>
                    <button class="btn ans-btn" style="background:var(--yellow); color:black" onclick="sendCmd('TARGET',3)">äº”</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal-mask"><div class="modal-card"><div id="modal-content"></div></div></div>

    <script>
        // === éš±å½¢é€šé“è¨­å®š (é‡è¦ï¼) ===
        // é€™æ˜¯ä¸€å€‹å›ºå®šçš„ IDï¼Œè®“è€å¸«å’Œå­¸ç”Ÿèƒ½æ‰¾åˆ°å°æ–¹
        // ç‚ºäº†é¿å…å’Œå…¶ä»–äººé‡è¤‡ï¼Œä½ å¯ä»¥éš¨ä¾¿æ”¹é€™ä¸²æ–‡å­—
        const SECRET_ROOM_ID = "chem-party-2025-auto-connect";

        // é¡Œåº«
        const questions = [
            {q:"1.é«˜åˆ†å­çš„åˆ†å­çµæ§‹ä¸€èˆ¬æ˜¯ï¼Ÿ", o:["å¾ˆå°åŸå­", "é•·éˆç‹€", "é‡‘å±¬æ’åˆ—", "æ°£é«”åˆ†å­"], a:1},
            {q:"2.ä¸‹åˆ—ä½•è€…æ˜¯ã€Œç†±å›ºæ€§å¡‘è† ã€ï¼Ÿ", o:["è† å¸¶", "ä¿éº—é¾", "é…šé†›æ¨¹è„‚", "å¯¶ç‰¹ç“¶"], a:2},
            {q:"3.æœ€å¸¸æ‹¿ä¾†åšã€Œé€æ˜è–„è†œã€ï¼Ÿ", o:["PE", "PS", "PP", "PVC"], a:3},
            {q:"4.å¯ä»¥è‡ªç„¶åˆ†è§£çš„é«˜åˆ†å­ï¼Ÿ", o:["PLA", "PS", "PVC", "PE"], a:0},
            {q:"5.ä¸‹åˆ—å“ªé …æ˜¯å¤©ç„¶é«˜åˆ†å­ï¼Ÿ", o:["è›‹ç™½è³ª", "ç»ç’ƒ", "çŸ³é ­", "æ°£é«”"], a:0},
            {q:"6.é«˜åˆ†å­æœ€åŸºæœ¬çµæ§‹å–®å…ƒï¼Ÿ", o:["å–®é«”", "èšåˆç‰©", "å¯¡èšç‰©", "é‡è¤‡å–®å…ƒ"], a:0},
            {q:"7.æå‡çµæ™¶åº¦çš„å› ç´ ï¼Ÿ", o:["å¢åŠ æ”¯éˆ", "é™ä½è¦å‰‡æ€§", "ç·šæ€§çµæ§‹", "å…±èšæ¯”ä¾‹"], a:2},
            {q:"8.ã€Œèšåˆã€çš„æ„æ€æ˜¯ï¼Ÿ", o:["åˆ†è£‚", "é€£æ¥èµ·ä¾†", "åˆ†è§£", "è’¸ç™¼"], a:1},
            {q:"9.åŠ ç†±å¾Œå¯é‡è¤‡ç†”åŒ–ï¼Ÿ", o:["ç†±å›ºæ€§", "ç†”å²©", "ç†±å¡‘æ€§", "çŸ³é ­"], a:2},
            {q:"10.éˆè¶Šé•·ï¼Œåˆ†å­é‡é€šå¸¸ï¼Ÿ", o:["ä¸è®Š", "è®Šå°", "è®Šå¤§", "éš¨ä¾¿"], a:2},
            {q:"11.é«˜åˆ†å­ç”¨é€”ä¸åŒ…æ‹¬ï¼Ÿ", o:["åŒ…è£", "å»ºç¯‰", "é›»å­", "é‡‘å±¬è£½å“"], a:3},
            {q:"12.å¤©ç„¶ä¾†æºæå–çš„é«˜åˆ†å­ï¼Ÿ", o:["PE", "PS", "PLA", "çº–ç¶­ç´ "], a:3},
            {q:"13.ç‰©ç†æ€§è³ªä¸å—ä½•è€…å½±éŸ¿ï¼Ÿ", o:["æº«åº¦", "åˆ†å­é‡", "çµæ§‹", "é¡è‰²"], a:3},
            {q:"14.PE æ°«è¢«æ°¯å–ä»£å¾Œè®Šæˆï¼Ÿ", o:["PP", "PS", "PVC", "PET"], a:2},
            {q:"15.è¤‡åˆææ–™è¨­è¨ˆç›®çš„ï¼Ÿ", o:["é™æˆæœ¬", "é™åˆ†å­é‡", "çµåˆç‰¹æ€§", "é™åˆ¶æ€§èƒ½"], a:2},
            {q:"16.ç†±å›ºæ€§é«˜åˆ†å­æè¿°ï¼Ÿ", o:["é‡è¤‡ç†”è", "è»ŸåŒ–", "å¤©ç„¶", "ä¸å¯å†ç†”"], a:3},
            {q:"17.å¤©ç„¶é«˜åˆ†å­æ˜¯ï¼Ÿ", o:["ABS", "å°¼é¾", "çº–ç¶­ç´ ", "PS"], a:2},
            {q:"18.PE çš„å–®é«”æ˜¯ï¼Ÿ", o:["ä¹™çƒ¯", "è‹¯", "æ°¨", "æ°¯åŒ–éˆ‰"], a:0},
            {q:"19.é«˜åˆ†å­çš„ã€Œé«˜ã€æ˜¯æŒ‡ï¼Ÿ", o:["å¯†åº¦", "é›»å°ç‡", "åˆ†å­é‡", "ç†”é»"], a:2},
            {q:"20.ç”±ä¸™çƒ¯å–®é«”è£½æˆï¼Ÿ", o:["PP", "PE", "PVC", "PS"], a:0},
            {q:"21.ç†±å¡‘æ€§å¡‘è† ä¾‹å­ï¼Ÿ", o:["ç’°æ°§æ¨¹è„‚", "èšç¢³é…¸é…¯", "é…šé†›", "èšæ°¨é…¯"], a:1},
            {q:"22.å¼·åº¦é€šå¸¸èˆ‡ä½•æœ‰é—œï¼Ÿ", o:["åˆ†å­é‡", "é¡è‰²", "å½¢ç‹€", "æ°£å‘³"], a:0},
            {q:"23.éç†±å¡‘æ€§ç‰¹æ€§ï¼Ÿ", o:["é‡è¤‡æˆå‹", "ä¸å¯é€†äº¤è¯", "èŒƒå¾·è¯åŠ›", "å¸¸è¦‹PE"], a:1},
            {q:"24.åŠ æˆèšåˆåæ‡‰ï¼Ÿ", o:["PLA", "å°¼é¾", "èšè‹¯ä¹™çƒ¯", "èšæ°¨é…¯"], a:2},
            {q:"25.çµæ™¶å€æ¯”ä¾‹è¶Šé«˜ï¼Ÿ", o:["é€æ˜", "å¯†åº¦ä½", "å¼·åº¦é«˜", "Tgå¢åŠ "], a:2},
            {q:"26.ç”Ÿç‰©å¯é™è§£èšåˆç‰©ï¼Ÿ", o:["PS", "PLA", "PVC", "PE"], a:1},
            {q:"27.åˆ†å­é‡åˆ†å¸ƒè®Šå¯¬ï¼Ÿ", o:["æ´»æ€§èšåˆ", "æ™‚é–“çŸ­", "æ§åˆ¶ç²¾ç¢º", "éˆè½‰ç§»"], a:3},
            {q:"28.èšåˆåº¦å¢åŠ æ™‚ï¼Ÿ", o:["åˆ†å­é‡å¢", "åˆ†å­é‡æ¸›", "è®Šé‡‘å±¬", "è®Šé€æ˜"], a:0},
            {q:"29.é»åº¦é«˜çš„ä¸»å› ï¼Ÿ", o:["éˆæ®µçºçµ", "æµå‹•å¿«", "æ°£æ…‹", "ç„¡ä½œç”¨åŠ›"], a:0},
            {q:"30.ç†±å¡‘æ€§ç‰¹æ€§ï¼Ÿ", o:["ä¸æ˜“å›æ”¶", "çµæ§‹ç©©å®š", "äº¤è¯", "é‡è¤‡ç†”è"], a:3},
            {q:"31.ç¸®åˆèšåˆåæ‡‰ï¼Ÿ", o:["PP", "PVC", "PET", "PE"], a:2},
            {q:"32.ç†±è®Šå½¢æº«åº¦æœ‰é—œï¼Ÿ", o:["åˆ†å­é‡", "çµæ™¶åº¦", "é¡è‰²", "å½¢ç‹€"], a:1},
            {q:"33.ç†±å›ºæ€§ä¾‹å­ï¼Ÿ", o:["ç’°æ°§æ¨¹è„‚", "èšæ°¨é…¯", "PP", "PE"], a:0},
            {q:"34.è€ç†±æ€§æœ‰é—œï¼Ÿ", o:["åˆ†å­çµæ§‹", "é¡è‰²", "å½¢ç‹€", "æ°£å‘³"], a:0},
            {q:"35.åˆæˆé«˜åˆ†å­ä¾‹å­ï¼Ÿ", o:["è›‹ç™½è³ª", "å¤©ç„¶æ©¡è† ", "PVC", "çº–ç¶­ç´ "], a:2}
        ];

        let peer, conn, myTeam = -1, turn = 0, state = "IDLE", currentQ = null;
        let connections = [];
        let players = [
            {n:"ç¬¬ä¸€çµ„", c:"var(--red)", p:0, s:0}, {n:"ç¬¬äºŒçµ„", c:"var(--blue)", p:0, s:0},
            {n:"ç¬¬ä¸‰çµ„", c:"var(--green)", p:0, s:0}, {n:"ç¬¬äº”çµ„", c:"var(--yellow)", p:0, s:0}
        ];
        const mapSize = 50; const cols = 10;
        let mapCells = [];

        function initMap() {
            mapCells = new Array(mapSize).fill("Q");
            mapCells[0] = "Start"; mapCells[mapSize-1] = "Finish";
            const sps = [{t:"Steal", c:5}, {t:"Swap", c:5}, {t:"Good", c:6}, {t:"Bad", c:6}];
            sps.forEach(sp => {
                for(let i=0; i<sp.c; i++) {
                    let r; do { r = Math.floor(Math.random()*(mapSize-2))+1; } while(mapCells[r] !== "Q");
                    mapCells[r] = sp.t;
                }
            });
        }

        // === é›»è…¦ç«¯ (Host) ===
        function startTeacher() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('teacher-ui').style.display = 'flex';
            initMap(); renderBoard(); highlightTurn();
            
            // ä½¿ç”¨å›ºå®š ID é–‹æˆ¿
            try {
                peer = new Peer(SECRET_ROOM_ID);
                peer.on('open', id => {
                    document.getElementById('host-status').innerText = "ç­‰å¾…å­¸ç”ŸåŠ å…¥...";
                });
                peer.on('error', err => {
                    if(err.type === 'unavailable-id') {
                        alert("æ³¨æ„ï¼šä¼¼ä¹å·²ç¶“æœ‰å¦ä¸€å€‹è¦–çª—é–‹å•Ÿäº†éŠæˆ²ï¼Œè«‹é—œé–‰å…¶ä»–è¦–çª—ã€‚");
                        // å˜—è©¦å¼·åˆ¶é€£ç·š
                        document.getElementById('host-status').innerText = "ID è¢«ä½”ç”¨";
                    } else {
                        alert("é€£ç·šéŒ¯èª¤ï¼š" + err.type);
                    }
                });
                peer.on('connection', c => {
                    connections.push(c);
                    document.getElementById('host-status').innerText = `${connections.length} äººå·²é€£ç·š`;
                    c.on('open', () => c.send({type:'STATE', turn:turn, state:state}));
                    c.on('data', data => {
                        if (data.team !== turn) return;
                        if (data.cmd === 'ROLL' && state === 'IDLE') rollDice();
                        if (data.cmd === 'ANS' && state === 'QUIZ') checkAnswer(data.val);
                        if (data.cmd === 'TARGET' && state === 'SELECT_TARGET') executeAction(data.val);
                    });
                });
            } catch(e) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); }
        }

        // === æ‰‹æ©Ÿç«¯ (Client) ===
        function joinGameAuto() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('conn-status').style.display = 'block';
            document.getElementById('conn-status').innerText = "æ­£åœ¨é€£ç·š...";
            
            peer = new Peer();
            peer.on('open', () => {
                // è‡ªå‹•é€£åˆ°å›ºå®š ID
                conn = peer.connect(SECRET_ROOM_ID);
                conn.on('open', () => {
                    document.getElementById('conn-status').style.display = 'none';
                    document.getElementById('student-ui').style.display = 'flex';
                    if(navigator.vibrate) navigator.vibrate(200);
                });
                conn.on('data', data => updatePad(data));
                conn.on('error', () => {
                    alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªè€å¸«å·²ç¶“é–‹å•Ÿé›»è…¦ç«¯");
                    document.getElementById('start-screen').style.display = 'flex';
                });
            });
            
            // è¶…æ™‚è™•ç†
            setTimeout(() => {
                if(!conn || !conn.open) {
                    document.getElementById('conn-status').innerText = "é€£ç·šéä¹…ï¼Œè«‹é‡è©¦";
                }
            }, 5000);
        }

        function setTeam(t) {
            myTeam = t;
            document.getElementById('student-ui').querySelector('.team-grid').parentElement.style.display = 'none';
            document.getElementById('pad-screen').style.display = 'flex';
        }

        function sendCmd(cmd, val) { if(conn) conn.send({cmd:cmd, team:myTeam, val:val}); if(navigator.vibrate) navigator.vibrate(50); }

        function updatePad(data) {
            let isMyTurn = (data.turn === myTeam);
            let status = document.getElementById('pad-msg');
            document.getElementById('pad-dice').style.display = 'none';
            document.getElementById('pad-quiz').style.display = 'none';
            document.getElementById('pad-target').style.display = 'none';
            if(isMyTurn) {
                status.style.color = players[myTeam].c;
                if(data.state === 'IDLE') {
                    status.innerText = "ğŸ‘‰ è¼ªåˆ°ä½ äº†ï¼"; document.getElementById('pad-dice').style.display = 'flex';
                    if(navigator.vibrate) navigator.vibrate([100,50,100]);
                } else if (data.state === 'QUIZ') {
                    status.innerText = "ğŸ‘‰ è«‹ä½œç­”ï¼"; document.getElementById('pad-quiz').style.display = 'flex';
                } else if (data.state === 'SELECT_TARGET') {
                    status.innerText = "ğŸ‘‰ é¸æ“‡ç›®æ¨™ï¼"; document.getElementById('pad-target').style.display = 'flex';
                } else status.innerText = "çœ‹å¤§è¢å¹•...";
            } else {
                status.style.color = "#888"; status.innerText = `ç­‰å¾… ${players[data.turn].n}...`;
            }
        }

        // === éŠæˆ²é‚è¼¯ ===
        function renderBoard() {
            const board = document.getElementById('board');
            for(let i=0; i<mapSize; i++) {
                let d = document.createElement('div');
                let type = mapCells[i];
                d.className = 'cell'; 
                let label = `<span>${i+1}</span>`;
                if(type === 'Start') { d.classList.add('Start'); label = '<span>ğŸš€</span>'; } 
                else if (type === 'Finish') { d.classList.add('Finish'); label = '<span>ğŸ†</span>'; }
                d.innerHTML = label;
                let row = Math.floor(i / cols) + 1; let col = (i % cols) + 1;
                if (row % 2 === 0) col = (cols + 1) - col;
                d.style.gridRow = row; d.style.gridColumn = col; d.id = `c-${i}`;
                board.appendChild(d);
            }
            players.forEach((p, i) => {
                let t = document.createElement('div');
                t.className = 'token'; t.innerHTML = ["ğŸ¯","ğŸ³","ğŸ¸","ğŸ¦"][i]; t.style.color = p.c; t.style.borderColor = p.c; t.id = `t-${i}`;
                // è€å¸«ä¸Šå¸ä¹‹æ‰‹
                t.onclick = () => { if(state==='IDLE' && confirm(`å¹« ${p.n} æ“²éª°å­ï¼Ÿ`)) rollDice(); };
                updateTokenPos(i, 0); document.getElementById('board').appendChild(t);
            });
        }
        function updateTokenPos(pid, cellIdx) {
            let cell = document.getElementById(`c-${cellIdx}`);
            let token = document.getElementById(`t-${pid}`);
            cell.appendChild(token);
            token.style.transform = `translate(${(pid%2)*12-6}px, ${Math.floor(pid/2)*12-6}px)`;
        }
        function highlightTurn() {
            for(let i=0; i<4; i++) document.getElementById(`card-${i}`).classList.remove('active');
            document.getElementById(`card-${turn}`).classList.add('active');
        }

        function rollDice() {
            state = 'MOVING'; broadcast(); playSfx('roll');
            let steps = Math.floor(Math.random()*6)+1;
            let p = players[turn];
            let c = 0;
            let t = setInterval(()=>{
                p.p++;
                if(p.p >= mapSize - 1) {
                    p.p = mapSize - 1; clearInterval(t); updateTokenPos(turn, p.p);
                    victory(p.n); return;
                }
                updateTokenPos(turn, p.p); c++;
                if(c >= steps) { clearInterval(t); checkEvent(p.p); }
            }, 300);
        }

        function checkEvent(pos) {
            let type = mapCells[pos];
            if (type === 'Q') openQuiz();
            else if (type === 'Good') showModal("âœ¨ å¥½é‹ï¼", "<span class='event-icon'>ğŸ’</span><br>é‹æ°£çˆ†æ£šï¼+20åˆ†", true, ()=>{adjustScore(20); nextTurn();}, "var(--green)");
            else if (type === 'Bad') showModal("ğŸ’€ å“å‘€ï¼", "<span class='event-icon'>ğŸ’£</span><br>è¸©åˆ°åœ°é›·ï¼-10åˆ†", true, ()=>{adjustScore(-10); nextTurn();}, "var(--red)");
            else if (type === 'Steal') showModal("ğŸ˜ˆ æ¶å¥ªï¼", "<span class='event-icon'>ğŸ˜ˆ</span><br>æ¶åˆ†æ™‚åˆ»ï¼çœ‹æ‰‹æ©Ÿé¸äºº...", false, ()=>{state='SELECT_TARGET'; broadcast();}, "var(--purple)");
            else if (type === 'Swap') showModal("â‡„ äº¤æ›ï¼", "<span class='event-icon'>â‡„</span><br>æ›ä½æ™‚åˆ»ï¼çœ‹æ‰‹æ©Ÿé¸äºº...", false, ()=>{state='SELECT_TARGET'; broadcast();}, "var(--yellow)");
            else nextTurn();
        }

        function executeAction(tIdx) {
            if (tIdx === turn) return;
            let type = mapCells[players[turn].p];
            if (type === 'Steal') {
                let amt = 20; if(players[tIdx].s < 20) amt = players[tIdx].s;
                players[tIdx].s -= amt; players[turn].s += amt;
                showModal("æˆåŠŸï¼", `å¾ ${players[tIdx].n} æ¶äº† ${amt} åˆ†ï¼`, true, ()=>{updateScores(); nextTurn();}, "var(--purple)");
            } else if (type === 'Swap') {
                let tmp = players[turn].p; players[turn].p = players[tIdx].p; players[tIdx].p = tmp;
                updateTokenPos(turn, players[turn].p); updateTokenPos(tIdx, players[tIdx].p);
                showModal("æˆåŠŸï¼", `èˆ‡ ${players[tIdx].n} äº¤æ›ä½ç½®ï¼`, true, ()=>nextTurn(), "var(--yellow)");
            }
        }

        function openQuiz() {
            state = 'QUIZ'; broadcast();
            let idx = Math.floor(Math.random()*questions.length);
            currentQ = questions[idx];
            let html = `
                <h2 style="margin:0 0 20px 0; font-size:1.8rem; color:#333;">${currentQ.q}</h2>
                <div style="text-align:left;">
                    ${currentQ.o.map((o,i) => `<div class="opt-row" onclick="checkAnswer(${i})"><b>${String.fromCharCode(65+i)}.</b> ${o}</div>`).join('')}
                </div>
                <h2 id="q-res" style="height:30px; margin-top:20px;"></h2>
                <button id="q-next" class="btn" style="display:none; background:var(--blue); color:white; padding:10px 40px; margin:20px auto;" onclick="closeModal()">ä¸‹ä¸€ä½</button>
            `;
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }

        function checkAnswer(ans) {
            if(ans === currentQ.a) {
                document.querySelectorAll('.opt-row')[ans].classList.add('correct');
                document.getElementById('q-res').innerText = "ç­”å°äº†ï¼"; document.getElementById('q-res').style.color = "var(--green)";
                playSfx('win'); adjustScore(10);
            } else {
                document.querySelectorAll('.opt-row')[ans].classList.add('wrong'); 
                document.querySelectorAll('.opt-row')[currentQ.a].classList.add('correct');
                document.getElementById('q-res').innerText = "ç­”éŒ¯äº†ï¼"; document.getElementById('q-res').style.color = "var(--red)";
                playSfx('fail');
            }
            document.getElementById('q-next').style.display = 'block';
        }

        function showModal(title, msg, btn, cb, color) {
            document.getElementById('modal-content').innerHTML = `
                <h1 style="color:${color}; margin:0;">${title}</h1>
                <p style="font-size:1.5rem; color:#555; margin:20px 0;">${msg}</p>
                ${btn ? `<button id="m-btn" class="btn" style="background:${color}; color:white; padding:10px 40px; margin:0 auto;">ç¢ºå®š</button>` : ''}
            `;
            document.getElementById('modal').style.display = 'flex';
            if(btn && cb) document.getElementById('m-btn').onclick = () => { document.getElementById('modal').style.display = 'none'; cb(); };
        }

        function victory(name) {
            playSfx('win'); confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
            showModal("å† è»ï¼", `ğŸ† æ­å–œ ${name} æŠµé”çµ‚é»ï¼`, false, null, "var(--yellow)");
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; nextTurn(); }
        function adjustScore(v) { players[turn].s += v; updateScores(); }
        function updateScores() { for(let i=0; i<4; i++) document.getElementById(`s${i+1}`).innerText = players[i].s; }
        function nextTurn() { turn = (turn + 1) % 4; state = 'IDLE'; highlightTurn(); broadcast(); }
        function broadcast() { connections.forEach(c => c.send({type:'STATE', turn:turn, state:state})); }
    </script>
</body>
</html>