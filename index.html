<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜åˆ†å­æ´¾å° (ç¶œè—ç‰¹æ•ˆç‰ˆ)</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    
    <style>
        /* === ğŸ¨ é¢¨æ ¼è¨­å®š === */
        :root {
            --bg-color: #2c3e50;
            --red: #e74c3c;   /* ç¬¬ä¸€çµ„ */
            --blue: #3498db;  /* ç¬¬äºŒçµ„ */
            --green: #2ecc71; /* ç¬¬ä¸‰çµ„ */
            --yellow: #f1c40f;/* ç¬¬äº”çµ„ */
            --text-color: #ecf0f1;
        }

        body {
            font-family: 'Varela Round', sans-serif; margin: 0; background-color: var(--bg-color);
            background-image: radial-gradient(#34495e 15%, transparent 16%), radial-gradient(#34495e 15%, transparent 16%);
            background-size: 60px 60px; background-position: 0 0, 30px 30px;
            color: var(--text-color); overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }

        .btn {
            border: none; outline: none; cursor: pointer; font-family: 'Varela Round', sans-serif; font-weight: bold;
            border-radius: 20px; transition: all 0.1s; box-shadow: 0 6px 0 rgba(0,0,0,0.4);
            text-transform: uppercase; display: flex; align-items: center; justify-content: center; user-select: none;
        }
        .btn:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.4); }
        .btn:disabled { background-color: #95a5a6 !important; color: #bdc3c7 !important; transform: none !important; box-shadow: none !important; cursor: not-allowed; }

        /* 1. èµ·å§‹é  */
        #start-screen {
            position: absolute; width: 100%; height: 100%; z-index: 100;
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .logo {
            background: white; padding: 20px 40px; border-radius: 30px;
            font-size: 3rem; color: var(--blue); box-shadow: 0 10px 20px rgba(0,0,0,0.3); transform: rotate(-3deg);
            margin-bottom: 20px; text-align: center;
        }
        .role-btn { width: 80%; max-width: 300px; padding: 20px; font-size: 1.5rem; color: white; border-radius: 20px; }
        .input-group { display: flex; gap: 10px; width: 80%; max-width: 300px; }
        #room-input { flex: 1; padding: 15px; border-radius: 15px; border: none; font-size: 1.5rem; text-align: center; outline: none; box-shadow: 0 4px 0 rgba(0,0,0,0.1); font-weight: bold; color: #333; }

        /* 2. é›»è…¦ç«¯ä»‹é¢ */
        #teacher-ui { display: none; width: 100%; height: 100%; flex-direction: column; position: relative; }
        
        /* é †åºæ¢ */
        .turn-order-bar {
            display: flex; justify-content: center; gap: 15px; padding: 15px; background: rgba(0,0,0,0.3);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;
        }
        .order-item {
            padding: 8px 20px; border-radius: 20px; font-weight: bold; color: #7f8c8d; border: 3px solid transparent; transition: 0.3s; background: rgba(255,255,255,0.1);
        }
        .order-item.active {
            color: white; transform: scale(1.15); box-shadow: 0 0 15px rgba(255,255,255,0.5); opacity: 1; border-color: white;
        }

        /* è€å¸«ç­‰å¾…å¤§å»³ */
        #host-lobby {
            position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .room-code-display { font-size: 6rem; font-weight: bold; color: var(--yellow); letter-spacing: 5px; margin: 20px 0; text-shadow: 0 0 20px rgba(241, 196, 15, 0.5); }
        .lobby-info { font-size: 1.5rem; margin-bottom: 40px; color: #bdc3c7; }

        .hud {
            height: 12%; display: flex; justify-content: center; gap: 20px; align-items: center; padding: 0 10px;
        }
        .score-card {
            background: #34495e; padding: 10px 25px; border-radius: 50px; font-size: 1.4rem; color: white;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 0 #2c3e50; border: 3px solid transparent; transition: 0.3s; opacity: 0.5;
        }
        .score-card.active { 
            transform: scale(1.1) translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); 
            border-color: currentColor; opacity: 1; font-weight: bold; background: white; color: #2c3e50 !important;
        }

        .board-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 10px; position: relative; }
        .board {
            display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(5, 1fr);
            gap: 6px; width: 95%; height: 85%; max-width: 1400px;
        }

        /* æ ¼å­æ¨£å¼ (ç›²ç›’) */
        .cell {
            background: white; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold; color: #bdc3c7; box-shadow: 0 4px 0 #95a5a6; position: relative; 
        }
        .cell.Start { background: #e74c3c; color: white; border: none; box-shadow: 0 4px 0 #c0392b; }
        .cell.Finish { background: #f1c40f; color: #d35400; border: 3px solid #d35400; }
        .cell.Mystery { background: #ecf0f1; color: #7f8c8d; } 
        
        /* æ£‹å­ */
        .token {
            width: 45px; height: 45px; border-radius: 50%; position: absolute; z-index: 10;
            background: white; border: 4px solid white; box-shadow: 0 5px 10px rgba(0,0,0,0.4);
            display: flex; justify-content: center; align-items: center; font-size: 1.8rem;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; opacity: 0.5; filter: grayscale(0.8);
        }
        .token.active-token { opacity: 1; filter: grayscale(0); transform: scale(1.3); animation: jump 1s infinite alternate; z-index: 20; box-shadow: 0 0 25px rgba(255,255,255,0.8); border-color: #f1c40f; }
        @keyframes jump { from{transform: translateY(0) scale(1.3);} to{transform: translateY(-15px) scale(1.3);} }

        /* 3. æ‰‹æ©Ÿç«¯ä»‹é¢ */
        #student-ui { display: none; width: 100%; height: 100%; flex-direction: column; background: #ecf0f1; color: #333;}
        .mobile-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .pad-msg { font-size: 2rem; color: #2c3e50; margin-bottom: 30px; font-weight: bold; text-align:center;}
        .big-action-btn { width: 250px; height: 250px; border-radius: 50%; font-size: 4rem; background: var(--yellow); color: #8a6d0b; box-shadow: 0 15px 0 #d4b106; }
        .big-action-btn:active { transform: translateY(15px); box-shadow: 0 0 0 #d4b106; }
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .ans-btn { height: 100px; font-size: 2rem; color: white; border-radius: 20px; }
        .target-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .wager-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 500px; }

        /* å½ˆçª— */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal-card { background: white; width: 90%; max-width: 700px; padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: bounceIn 0.4s; max-height: 90vh; overflow-y: auto; color: #333; }
        @keyframes bounceIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        .opt-row { background: #ecf0f1; padding: 20px; margin: 15px 0; border-radius: 15px; text-align: left; font-size: 1.4rem; border: 3px solid transparent; cursor: pointer; transition: background 0.2s; font-weight: bold; color: #2c3e50;}
        .opt-row:hover { background: #bdc3c7; } 
        .opt-row.correct { background: #2ecc71; border-color: #27ae60; color: white;}
        .opt-row.wrong { background: #e74c3c; border-color: #c0392b; color: white;}
        
        #next-btn { 
            animation: pulseBtn 1s infinite; 
            font-size: 1.8rem; padding: 20px; border-radius: 15px; width: 100%; margin-top: 25px;
            background: var(--green); color: white; border: none; cursor: pointer; display: none; box-shadow: 0 8px 0 #27ae60;
        }
        #next-btn:active { transform: translateY(8px); box-shadow: none; }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        .rank-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; font-size: 1.5rem; }
        .rank-row b { color: var(--blue); }

        .turn-banner { position: absolute; top: 20%; width: 100%; text-align: center; font-size: 4rem; font-weight: 900; text-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 15; color: white; pointer-events: none; opacity: 0; transition: 0.3s; transform: scale(0.8); }
        .turn-banner.show { opacity: 1; transform: scale(1.2); }
        #conn-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; flex-direction: column; align-items: center; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); color:#333;}
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="logo">ğŸ§ª é«˜åˆ†å­æ´¾å°</div>
        <button class="btn role-btn" style="background:var(--blue);" onclick="startTeacher()">ğŸ’» æˆ‘æ˜¯é›»è…¦ (Host)</button>
        <div style="width:80%; height:1px; background:rgba(255,255,255,0.2); margin:20px 0;"></div>
        <div class="input-group"><input type="tel" id="room-input" placeholder="è¼¸å…¥æˆ¿é–“è™Ÿç¢¼" maxlength="4"></div>
        <button class="btn role-btn" style="background:white; color:var(--blue);" onclick="startStudent()">ğŸ“± æ‰‹æ©ŸåŠ å…¥</button>
        <button class="btn" style="background:rgba(255,255,255,0.1); color:#bdc3c7; font-size:0.9rem; margin-top:20px; padding:10px 20px;" onclick="startOffline()">âš ï¸ å–®æ©Ÿç‰ˆ</button>
    </div>

    <div id="conn-msg"><div style="font-size:3rem">ğŸ”„</div><h3>é€£ç·šä¸­...</h3></div>

    <div id="teacher-ui">
        <div class="turn-order-bar">
            <div id="order-0" class="order-item" style="background:var(--red)">ç¬¬ä¸€çµ„</div><div style="align-self:center; color:#7f8c8d">âœ</div>
            <div id="order-1" class="order-item" style="background:var(--blue)">ç¬¬äºŒçµ„</div><div style="align-self:center; color:#7f8c8d">âœ</div>
            <div id="order-2" class="order-item" style="background:var(--green)">ç¬¬ä¸‰çµ„</div><div style="align-self:center; color:#7f8c8d">âœ</div>
            <div id="order-3" class="order-item" style="background:var(--yellow); color:#444">ç¬¬äº”çµ„</div>
        </div>

        <div id="host-lobby">
            <h2 style="margin:0; opacity:0.8;">è«‹å­¸ç”Ÿè¼¸å…¥æˆ¿é–“è™Ÿç¢¼</h2>
            <div id="lobby-code" class="room-code-display">----</div>
            <div class="lobby-info" id="lobby-status">ç›®å‰é€£ç·š: 0</div>
            <button class="btn" style="background:var(--green); color:white; padding: 20px 60px; font-size: 2rem;" onclick="closeLobby()">ğŸš€ é–‹å§‹éŠæˆ²</button>
        </div>

        <div id="turn-banner" class="turn-banner">æº–å‚™é–‹å§‹</div>

        <div class="hud">
            <div id="card-0" class="score-card" style="color:var(--red)"><span>ğŸ¯ ç¬¬ä¸€çµ„</span> <span id="s0">0</span></div>
            <div id="card-1" class="score-card" style="color:var(--blue)"><span>ğŸ³ ç¬¬äºŒçµ„</span> <span id="s1">0</span></div>
            <div id="card-2" class="score-card" style="color:var(--green)"><span>ğŸ¸ ç¬¬ä¸‰çµ„</span> <span id="s2">0</span></div>
            <div id="card-3" class="score-card" style="color:var(--yellow)"><span>ğŸ¦ ç¬¬äº”çµ„</span> <span id="s3">0</span></div>
        </div>
        <div class="board-container"><div class="board" id="board"></div></div>
    </div>

    <div id="student-ui">
        <div id="team-select" class="mobile-center">
            <h2 style="color:var(--blue); margin-top:0;">è«‹é¸æ“‡çµ„åˆ¥</h2>
            <div class="team-grid">
                <button class="btn" style="background:var(--red); color:white; padding:30px;" onclick="joinGame(0)">ğŸ¯ ç¬¬ä¸€çµ„</button>
                <button class="btn" style="background:var(--blue); color:white; padding:30px;" onclick="joinGame(1)">ğŸ³ ç¬¬äºŒçµ„</button>
                <button class="btn" style="background:var(--green); color:white; padding:30px;" onclick="joinGame(2)">ğŸ¸ ç¬¬ä¸‰çµ„</button>
                <button class="btn" style="background:var(--yellow); color:black; padding:30px;" onclick="joinGame(3)">ğŸ¦ ç¬¬äº”çµ„</button>
            </div>
        </div>
        <div id="pad-screen" class="mobile-center" style="display:none;">
            <div id="pad-msg" class="pad-msg">ç­‰å¾…ä¸­...</div>
            <div id="pad-dice" style="display:none;"><button class="btn big-action-btn" onclick="sendCmd('ROLL')">ğŸ²</button></div>
            
            <div id="pad-wager" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <h2 style="margin-bottom:20px;">ğŸ² ä¸‹æ³¨æ™‚åˆ»</h2>
                <div class="pad-msg" id="wager-info" style="font-size:1.2rem; color:#555; margin-bottom:10px;">æœ¬é¡Œåƒ¹å€¼: ?? åˆ†</div>
                <div class="wager-grid">
                    <button class="btn" id="btn-wager-1" style="background:var(--blue); color:white; padding:20px; font-size:1.2rem;" onclick="sendCmd('WAGER', 1)">ğŸ›¡ï¸ ä¸ç¿»å€</button>
                    <button class="btn" id="btn-wager-rand" style="background:var(--yellow); color:black; padding:20px; font-size:1.2rem;" onclick="sendCmd('WAGER', 'R')">ğŸ° éš¨æ©Ÿ (x2~x5)</button>
                </div>
            </div>

            <div id="pad-quiz" style="display:none; width:100%; justify-content:center;">
                <div class="ans-grid">
                    <button class="btn ans-btn" style="background:var(--red)" onclick="sendCmd('ANS',0)">A</button>
                    <button class="btn ans-btn" style="background:var(--blue)" onclick="sendCmd('ANS',1)">B</button>
                    <button class="btn ans-btn" style="background:var(--green)" onclick="sendCmd('ANS',2)">C</button>
                    <button class="btn ans-btn" style="background:var(--yellow); color:black" onclick="sendCmd('ANS',3)">D</button>
                </div>
            </div>
            <div id="pad-target" style="display:none; width:100%; justify-content:center;">
                <div class="pad-msg" style="font-size:1.5rem">è«‹é¸æ“‡å°è±¡</div>
                <div class="target-grid" id="mobile-target-grid"></div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal-mask"><div class="modal-card"><div id="modal-content"></div></div></div>

    <script>
        const APP_PREFIX = "poly-party-2025-sync-v4-"; 
        const peerConfig = { config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } };
        
        const allQuestions = [
            {q:"1.é«˜åˆ†å­çš„åˆ†å­çµæ§‹ä¸€èˆ¬æ˜¯ï¼Ÿ", o:["å¾ˆå°åŸå­", "é•·éˆç‹€", "é‡‘å±¬æ’åˆ—", "æ°£é«”åˆ†å­"], a:1},
            {q:"2.ä¸‹åˆ—ä½•è€…æ˜¯ã€Œç†±å›ºæ€§å¡‘è† ã€ï¼Ÿ", o:["è† å¸¶", "ä¿éº—é¾", "é…šé†›æ¨¹è„‚", "å¯¶ç‰¹ç“¶"], a:2},
            {q:"3.æœ€å¸¸æ‹¿ä¾†åšã€Œé€æ˜è–„è†œã€ï¼Ÿ", o:["PE", "PS", "PP", "PVC"], a:3},
            {q:"4.å¯ä»¥è‡ªç„¶åˆ†è§£çš„é«˜åˆ†å­ï¼Ÿ", o:["PLA", "PS", "PVC", "PE"], a:0},
            {q:"5.ä¸‹åˆ—å“ªé …æ˜¯å¤©ç„¶é«˜åˆ†å­ï¼Ÿ", o:["è›‹ç™½è³ª", "ç»ç’ƒ", "çŸ³é ­", "æ°£é«”"], a:0},
            {q:"6.é«˜åˆ†å­æœ€åŸºæœ¬çµæ§‹å–®å…ƒï¼Ÿ", o:["å–®é«”", "èšåˆç‰©", "å¯¡èšç‰©", "é‡è¤‡å–®å…ƒ"], a:0},
            {q:"7.æå‡çµæ™¶åº¦çš„å› ç´ ï¼Ÿ", o:["å¢åŠ æ”¯éˆ", "é™ä½è¦å‰‡æ€§", "ç·šæ€§çµæ§‹", "å…±èšæ¯”ä¾‹"], a:2},
            {q:"8.ã€Œèšåˆã€çš„æ„æ€æ˜¯ï¼Ÿ", o:["åˆ†è£‚", "é€£æ¥èµ·ä¾†", "åˆ†è§£", "è’¸ç™¼"], a:1},
            {q:"9.åŠ ç†±å¾Œå¯é‡è¤‡ç†”åŒ–ï¼Ÿ", o:["ç†±å›ºæ€§", "ç†”å²©", "ç†±å¡‘æ€§", "çŸ³é ­"], a:2},
            {q:"10.éˆè¶Šé•·ï¼Œåˆ†å­é‡é€šå¸¸ï¼Ÿ", o:["ä¸è®Š", "è®Šå°", "è®Šå¤§", "éš¨ä¾¿"], a:2},
            {q:"11.é«˜åˆ†å­ç”¨é€”ä¸åŒ…æ‹¬ï¼Ÿ", o:["åŒ…è£", "å»ºç¯‰", "é›»å­", "é‡‘å±¬è£½å“"], a:3},
            {q:"12.å¤©ç„¶ä¾†æºæå–çš„é«˜åˆ†å­ï¼Ÿ", o:["PE", "PS", "PLA", "çº–ç¶­ç´ "], a:3},
            {q:"13.ç‰©ç†æ€§è³ªä¸å—ä½•è€…å½±éŸ¿ï¼Ÿ", o:["æº«åº¦", "åˆ†å­é‡", "çµæ§‹", "é¡è‰²"], a:3},
            {q:"14.PE æ°«è¢«æ°¯å–ä»£å¾Œè®Šæˆï¼Ÿ", o:["PP", "PS", "PVC", "PET"], a:2},
            {q:"15.è¤‡åˆææ–™è¨­è¨ˆç›®çš„ï¼Ÿ", o:["é™æˆæœ¬", "é™åˆ†å­é‡", "çµåˆç‰¹æ€§", "é™åˆ¶æ€§èƒ½"], a:2},
            {q:"16.ç†±å›ºæ€§é«˜åˆ†å­æè¿°ï¼Ÿ", o:["é‡è¤‡ç†”è", "è»ŸåŒ–", "å¤©ç„¶", "ä¸å¯å†ç†”"], a:3},
            {q:"17.å¤©ç„¶é«˜åˆ†å­æ˜¯ï¼Ÿ", o:["ABS", "å°¼é¾", "çº–ç¶­ç´ ", "PS"], a:2},
            {q:"18.PE çš„å–®é«”æ˜¯ï¼Ÿ", o:["ä¹™çƒ¯", "è‹¯", "æ°¨", "æ°¯åŒ–éˆ‰"], a:0},
            {q:"19.é«˜åˆ†å­çš„ã€Œé«˜ã€æ˜¯æŒ‡ï¼Ÿ", o:["å¯†åº¦", "é›»å°ç‡", "åˆ†å­é‡", "ç†”é»"], a:2},
            {q:"20.ç”±ä¸™çƒ¯å–®é«”è£½æˆï¼Ÿ", o:["PP", "PE", "PVC", "PS"], a:0},
            {q:"21.ç†±å¡‘æ€§å¡‘è† ä¾‹å­ï¼Ÿ", o:["ç’°æ°§æ¨¹è„‚", "èšç¢³é…¸é…¯", "é…šé†›", "èšæ°¨é…¯"], a:1},
            {q:"22.å¼·åº¦é€šå¸¸èˆ‡ä½•æœ‰é—œï¼Ÿ", o:["åˆ†å­é‡", "é¡è‰²", "å½¢ç‹€", "æ°£å‘³"], a:0},
            {q:"23.éç†±å¡‘æ€§ç‰¹æ€§ï¼Ÿ", o:["é‡è¤‡æˆå‹", "ä¸å¯é€†äº¤è¯", "èŒƒå¾·è¯åŠ›", "å¸¸è¦‹PE"], a:1},
            {q:"24.åŠ æˆèšåˆåæ‡‰ï¼Ÿ", o:["PLA", "å°¼é¾", "èšè‹¯ä¹™çƒ¯", "èšæ°¨é…¯"], a:2},
            {q:"25.çµæ™¶å€æ¯”ä¾‹è¶Šé«˜ï¼Ÿ", o:["é€æ˜", "å¯†åº¦ä½", "å¼·åº¦é«˜", "Tgå¢åŠ "], a:2},
            {q:"26.ç”Ÿç‰©å¯é™è§£èšåˆç‰©ï¼Ÿ", o:["PS", "PLA", "PVC", "PE"], a:1},
            {q:"27.åˆ†å­é‡åˆ†å¸ƒè®Šå¯¬ï¼Ÿ", o:["æ´»æ€§èšåˆ", "æ™‚é–“çŸ­", "æ§åˆ¶ç²¾ç¢º", "éˆè½‰ç§»"], a:3},
            {q:"28.èšåˆåº¦å¢åŠ æ™‚ï¼Ÿ", o:["åˆ†å­é‡å¢", "åˆ†å­é‡æ¸›", "è®Šé‡‘å±¬", "è®Šé€æ˜"], a:0},
            {q:"29.é»åº¦é«˜çš„ä¸»å› ï¼Ÿ", o:["éˆæ®µçºçµ", "æµå‹•å¿«", "æ°£æ…‹", "ç„¡ä½œç”¨åŠ›"], a:0},
            {q:"30.ç†±å¡‘æ€§ç‰¹æ€§ï¼Ÿ", o:["ä¸æ˜“å›æ”¶", "çµæ§‹ç©©å®š", "äº¤è¯", "é‡è¤‡ç†”è"], a:3},
            {q:"31.ç¸®åˆèšåˆåæ‡‰ï¼Ÿ", o:["PP", "PVC", "PET", "PE"], a:2},
            {q:"32.ç†±è®Šå½¢æº«åº¦æœ‰é—œï¼Ÿ", o:["åˆ†å­é‡", "çµæ™¶åº¦", "é¡è‰²", "å½¢ç‹€"], a:1},
            {q:"33.ç†±å›ºæ€§ä¾‹å­ï¼Ÿ", o:["ç’°æ°§æ¨¹è„‚", "èšæ°¨é…¯", "PP", "PE"], a:0},
            {q:"34.è€ç†±æ€§æœ‰é—œï¼Ÿ", o:["åˆ†å­çµæ§‹", "é¡è‰²", "å½¢ç‹€", "æ°£å‘³"], a:0},
            {q:"35.åˆæˆé«˜åˆ†å­ä¾‹å­ï¼Ÿ", o:["è›‹ç™½è³ª", "å¤©ç„¶æ©¡è† ", "PVC", "çº–ç¶­ç´ "], a:2}
        ];
        
        let questionPool = [];
        let peer, conn, myTeam = -1, turn = 0, state = "IDLE", currentQ = null, currentMultiplier = 1, currentBaseScore = 20;
        let pendingEvent = null;
        let connections = [];
        let players = [
            {n:"ç¬¬ä¸€çµ„", c:"var(--red)", p:0, s:0}, {n:"ç¬¬äºŒçµ„", c:"var(--blue)", p:0, s:0},
            {n:"ç¬¬ä¸‰çµ„", c:"var(--green)", p:0, s:0}, {n:"ç¬¬äº”çµ„", c:"var(--yellow)", p:0, s:0}
        ];
        const mapSize = 50; const cols = 10;
        let mapCells = [];
        let lastReceivedState = {turn: 0, state: 'IDLE'};
        let audioCtx; 
        let isSwitchingTurn = false; 

        window.onload = function() { 
            try { shuffleQuestions(); initMap(); renderBoard(); } catch(e) {}
        };

        function initAudio() { try { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(audioCtx.state === 'suspended') audioCtx.resume(); } catch(e) {} }
        function playSfx(name) { try { if(!audioCtx) initAudio(); if(!audioCtx) return; const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.connect(g); g.connect(audioCtx.destination); if(name==='roll'){osc.type='triangle';osc.frequency.setValueAtTime(200,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);osc.start();osc.stop(audioCtx.currentTime+0.2);} if(name==='win'){osc.type='sine';osc.frequency.setValueAtTime(400,audioCtx.currentTime);g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.5);osc.start();osc.stop(audioCtx.currentTime+0.5);} if(name==='fail'){osc.type='sawtooth';osc.frequency.setValueAtTime(100,audioCtx.currentTime);g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.4);osc.start();osc.stop(audioCtx.currentTime+0.4);} } catch(e) {} }
        function vibe(p) { if(navigator.vibrate) navigator.vibrate(p); }

        function shuffleQuestions() {
            questionPool = [...allQuestions];
            for (let i = questionPool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [questionPool[i], questionPool[j]] = [questionPool[j], questionPool[i]]; }
        }
        function getNextQuestion() { if(questionPool.length === 0) shuffleQuestions(); return questionPool.pop(); }

        function initMap() {
            let types = [];
            for(let i=0; i<18; i++) types.push("Q");
            for(let i=0; i<8; i++) types.push("Steal"); 
            for(let i=0; i<6; i++) types.push("Swap");
            for(let i=0; i<6; i++) types.push("Gift");
            for(let i=0; i<5; i++) types.push("Return");
            for(let i=0; i<5; i++) types.push("Bankrupt");
            for (let i = types.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [types[i], types[j]] = [types[j], types[i]]; }
            mapCells = new Array(mapSize); mapCells[0] = "Start"; mapCells[mapSize-1] = "Finish";
            for(let i=1; i<mapSize-1; i++) { mapCells[i] = types[i-1] || "Q"; }
        }

        function startTeacher() {
            initAudio();
            const roomCode = Math.floor(1000 + Math.random() * 9000);
            const peerId = APP_PREFIX + roomCode;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('teacher-ui').style.display = 'flex';
            document.getElementById('lobby-code').innerText = roomCode;
            try {
                peer = new Peer(peerId, peerConfig);
                peer.on('connection', c => {
                    connections.push(c);
                    document.getElementById('lobby-status').innerText = `ç›®å‰é€£ç·š: ${connections.length}`;
                    setTimeout(() => { if(c.open) c.send({type:'STATE', turn:turn, state:state, baseScore:currentBaseScore}); }, 500);
                    c.on('data', d => {
                        if(d.team !== turn || isSwitchingTurn) return;
                        if(d.cmd === 'ROLL' && state === 'IDLE') rollDice();
                        if(d.cmd === 'WAGER' && state === 'WAGER') setWager(d.val);
                        if(d.cmd === 'ANS' && state === 'QUIZ') checkAns(d.val);
                        if(d.cmd === 'TARGET' && state === 'SELECT_TARGET') executeSpecial(d.val, d.action);
                    });
                });
            } catch(e) { alert("ä¸æ”¯æ´ WebRTC"); }
        }

        function closeLobby() { document.getElementById('host-lobby').style.display = 'none'; highlightTurn(); safeBroadcast(); }

        function startStudent() {
            initAudio();
            const code = document.getElementById('room-input').value;
            if(!code) return alert("è«‹è¼¸å…¥æˆ¿é–“è™Ÿ");
            const hostId = APP_PREFIX + code;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('conn-msg').style.display = 'flex';
            try {
                peer = new Peer(peerConfig); 
                peer.on('open', () => {
                    conn = peer.connect(hostId, {reliable: true});
                    conn.on('open', () => {
                        document.getElementById('conn-msg').style.display = 'none';
                        document.getElementById('student-ui').style.display = 'flex';
                    });
                    conn.on('data', d => { 
                        turn = d.turn; 
                        lastReceivedState = d; 
                        updatePad(d); 
                    });
                });
            } catch(e) { alert("ä¸æ”¯æ´"); }
        }

        function startOffline() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('teacher-ui').style.display = 'flex';
            document.getElementById('host-lobby').style.display = 'none';
            highlightTurn();
        }

        function joinGame(t) {
            myTeam = t;
            document.getElementById('team-select').style.display = 'none';
            document.getElementById('pad-screen').style.display = 'flex';
            if(lastReceivedState) updatePad(lastReceivedState);
        }

        function sendCmd(cmd, val, action) { if(conn && conn.open) { conn.send({cmd, val, action, team:myTeam}); vibe(50); } }

        function updatePad(data) {
            let isMyTurn = (data.turn === myTeam);
            let status = document.getElementById('pad-msg');
            document.getElementById('pad-dice').style.display = 'none';
            document.getElementById('pad-quiz').style.display = 'none';
            document.getElementById('pad-target').style.display = 'none';
            document.getElementById('pad-wager').style.display = 'none';
            
            if(isMyTurn) {
                status.style.color = players[myTeam].c;
                if(data.state === 'IDLE') {
                    status.innerText = "ğŸ‘‰ è¼ªåˆ°ä½ äº†ï¼"; document.getElementById('pad-dice').style.display = 'flex'; vibe([100,50,100]);
                } else if (data.state === 'WAGER') {
                    status.innerText = "ğŸ‘‰ ä¸‹æ³¨æ™‚é–“"; 
                    document.getElementById('pad-wager').style.display = 'flex';
                    document.getElementById('wager-info').innerText = `æœ¬é¡Œåƒ¹å€¼: ${data.baseScore} åˆ†`;
                    document.getElementById('btn-wager-1').innerHTML = `ğŸ›¡ï¸ ä¸€èˆ¬`;
                    document.getElementById('btn-wager-rand').innerHTML = `ğŸ° éš¨æ©Ÿ (x2~x5)`;
                } else if (data.state === 'QUIZ') {
                    status.innerText = "ğŸ‘‰ è«‹ä½œç­”ï¼"; document.getElementById('pad-quiz').style.display = 'flex';
                } else if (data.state === 'SELECT_TARGET') {
                    document.getElementById('pad-target').style.display = 'flex';
                    renderMobileTargets(data.targets || []); 
                } else status.innerText = "çœ‹å¤§è¢å¹•...";
            } else {
                status.style.color = "#888"; status.innerText = `ç­‰å¾… ${players[data.turn].n}...`;
            }
        }
        
        function renderMobileTargets(targetIndices) {
             let grid = document.getElementById('mobile-target-grid');
             grid.innerHTML = '';
             targetIndices.forEach(idx => {
                 let p = players[idx];
                 let btn = document.createElement('button');
                 btn.className = 'btn';
                 btn.style.background = p.c;
                 btn.style.color = 'white';
                 btn.innerText = `é¸ ${p.n}`;
                 btn.onclick = () => sendCmd('TARGET', idx, null);
                 grid.appendChild(btn);
             });
        }

        function renderBoard() {
            const b = document.getElementById('board');
            if(!b) return; b.innerHTML = ''; 
            for(let i=0; i<mapSize; i++) {
                let d = document.createElement('div'); d.className = `cell ${mapCells[i]}`;
                if(mapCells[i]==='Start') d.innerText = "ğŸš€";
                else if(mapCells[i]==='Finish') d.innerText = "ğŸ†";
                else d.className = "cell Mystery"; // ç›²ç›’
                if(mapCells[i]!=='Start' && mapCells[i]!=='Finish') d.innerText = "?";
                let r = Math.floor(i/cols)+1; let c = (i%cols)+1;
                if(r%2===0) c = (cols+1)-c; d.style.gridRow=r; d.style.gridColumn=c; d.id=`c-${i}`;
                b.appendChild(d);
            }
            players.forEach((p,i) => { updateTokenPos(i, 0); });
        }
        
        function updateTokenPos(pid, idx) {
            let cell = document.getElementById(`c-${idx}`);
            let token = document.getElementById(`t-${pid}`);
            if(!token) {
                let p = players[pid];
                token = document.createElement('div'); token.className = 'token'; 
                token.innerText = ["ğŸ¯","ğŸ³","ğŸ¸","ğŸ¦"][pid]; 
                token.style.color=p.c; token.style.borderColor=p.c; token.id=`t-${pid}`;
                token.onclick = () => { if(state==='IDLE' && turn===pid && !isSwitchingTurn && confirm(`å¹« ${p.n} æ“²éª°å­ï¼Ÿ`)) rollDice(); };
            }
            if(cell) cell.appendChild(token);
        }
        
        function highlightTurn() {
            for(let i=0; i<4; i++) document.getElementById(`card-${i}`).classList.remove('active');
            document.getElementById(`card-${turn}`).classList.add('active');
            document.querySelectorAll('.token').forEach(t => t.classList.remove('active-token'));
            let ct = document.getElementById(`t-${turn}`); if(ct) ct.classList.add('active-token');
            for(let i=0; i<4; i++) document.getElementById(`order-${i}`).classList.remove('active');
            document.getElementById(`order-${turn}`).classList.add('active');
            let banner = document.getElementById('turn-banner');
            banner.innerText = `è¼ªåˆ°ï¼š${players[turn].n}`; banner.style.color = players[turn].c;
            banner.classList.add('show'); setTimeout(() => { banner.classList.remove('show'); }, 2000);
        }

        function rollDice() {
            if(isSwitchingTurn) return; 
            
            // 1. æ“²éª°å‹•ç•«
            let steps = Math.floor(Math.random()*6)+1;
            showModal("ğŸ²", `<div style="font-size:5rem; color:var(--blue)">${steps}</div><p>æ­¥</p>`, false);
            
            setTimeout(() => {
                closeModal(); // é—œé–‰éª°å­è¦–çª—ï¼Œä¸è§¸ç™¼ nextTurn
                state = 'MOVING'; safeBroadcast(); playSfx('roll');
                
                let p = players[turn]; let c = 0;
                let t = setInterval(()=>{
                    p.p++;
                    if(p.p >= mapSize-1) {
                        p.p = mapSize-1; clearInterval(t); updateTokenPos(turn, p.p); victory(p.n); return;
                    }
                    updateTokenPos(turn, p.p); c++;
                    if(c >= steps) { clearInterval(t); checkEvent(p.p); }
                }, 300);
            }, 1500);
        }

        function safeBroadcast(extras = {}) {
            let payload = {type:'STATE', turn:turn, state:state, baseScore:currentBaseScore, ...extras};
            try { connections.forEach(c => { if(c.open) c.send(payload); }); } catch(e) {}
        }

        function checkEvent(pos) {
            let t = mapCells[pos];
            pendingEvent = type = (t === 'Q' ? null : t); 
            openWager(); 
        }

        function finishQuiz(btn) {
            if(btn) btn.disabled = true;
            document.getElementById('modal').style.display = 'none';
            if(pendingEvent) {
                setTimeout(() => { revealSurprise(pendingEvent); }, 500);
            } else {
                nextTurn();
            }
        }

        function revealSurprise(type) {
            if(type === 'Gift') showModal("ğŸ å¤©é™å¥½ç¦®ï¼", "å‰›å‰›çš„é¡Œç›®åªæ˜¯æš–èº«ï¼Œå†é€ä½  30 åˆ†ï¼", true, ()=>{players[turn].s+=30; nextTurn();});
            else if(type === 'Return') showModal("ğŸ  æ…˜é­é€€è²¨ï¼", "é›–ç„¶ä½ ç­”å®Œäº†ï¼Œä½†è«‹ä½ å›åˆ°åŸé» (ç¬‘)", true, ()=>{players[turn].p=0; updateTokenPos(turn,0); nextTurn();});
            else if(type === 'Bankrupt') showModal("ğŸ’¸ ç ´ç”¢å•¦ï¼", "ä¸ç®¡ä½ å‰›å‰›è³ºå¤šå°‘ï¼Œç¾åœ¨é€šé€šæ­¸é›¶ï¼", true, ()=>{players[turn].s=0; nextTurn();});
            else if(type === 'Steal' || type === 'Swap') {
                state = 'SELECT_TARGET'; 
                
                let validTargets = [];
                players.forEach((p, i) => { if(i !== turn) validTargets.push(i); });
                safeBroadcast({targets: validTargets}); 

                let title = type === 'Steal' ? "ğŸ˜ˆ è§¸ç™¼æ¶å¥ªäº‹ä»¶ï¼" : "ğŸ”„ è§¸ç™¼éˆé­‚äº¤æ›ï¼";
                let desc = type === 'Steal' ? "è«‹é¸æ“‡ä¸€å€‹å€’éœ‰é¬¼ï¼Œéš¨æ©Ÿæ¶èµ°ä»–çš„åˆ†æ•¸ (10%~100%)ï¼š" : "è«‹é¸æ“‡ä¸€å€‹å°è±¡äº¤æ›åˆ†æ•¸ï¼š";
                
                let html = `<h1>${title}</h1><p>${desc}</p><div class="target-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">`;
                players.forEach((p,i) => {
                    if(i!==turn) html += `<button class="btn" style="background:${p.c}; color:white; padding:15px;" onclick="executeSpecial(${i}, null)">${p.n}</button>`;
                });
                html += `</div>`;
                document.getElementById('modal-content').innerHTML = html;
                document.getElementById('modal').style.display='flex';
            }
            else nextTurn();
        }

        function executeSpecial(targetIdx, action) {
            if(isSwitchingTurn) return; 
            document.getElementById('modal').style.display='none';
            if(!action) action = pendingEvent === 'Swap' ? 'swap' : 'steal';

            if(action === 'steal') {
                let percent = Math.floor(Math.random() * 91) + 10; 
                let stolen = Math.floor(players[targetIdx].s * (percent/100)); 
                if(players[targetIdx].s <= 0) stolen = 0;
                players[targetIdx].s -= stolen; players[turn].s += stolen;
                alert(`ğŸ˜ˆ æ¶å¥ªæˆåŠŸ (${percent}%)ï¼\nå¾ ${players[targetIdx].n} æ¶èµ°äº† ${stolen} åˆ†ï¼`);
            } else if (action === 'swap') {
                let temp = players[turn].s;
                players[turn].s = players[targetIdx].s;
                players[targetIdx].s = temp;
                alert(`ğŸ”„ äº¤æ›æˆåŠŸï¼\nä½ ç¾åœ¨çš„åˆ†æ•¸æ˜¯ ${players[turn].s} åˆ†ï¼`);
            }
            nextTurn();
        }

        function openWager() {
            state = 'WAGER'; 
            currentBaseScore = (Math.floor(Math.random() * 5) + 1) * 10; 
            currentMultiplier = 1;
            safeBroadcast();

            let html = `<h1>ğŸ² æ©Ÿæœƒå‘½é‹</h1>
            <p>æœ¬é¡Œåƒ¹å€¼ <b style="color:var(--blue); font-size:2rem;">${currentBaseScore} åˆ†</b></p>
            <p>ä½ è¦ä¸‹å¤šå°‘æ³¨ï¼Ÿ</p>
            <div class="wager-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn" style="background:var(--blue); color:white; padding:20px;" onclick="setWager(1, this)">ğŸ›¡ï¸ ä¸€èˆ¬</button>
                <button class="btn" style="background:var(--yellow); color:black; padding:20px;" onclick="setWager('R', this)">ğŸ° éš¨æ©Ÿç¿»å€ (x2~x5)</button>
            </div>`;
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }

        function setWager(m, btn) {
            if(btn) btn.disabled = true;
            if(m === 'R') {
                currentMultiplier = Math.floor(Math.random() * 4) + 2;
                // é¡¯ç¤ºå€ç‡å‹•ç•«
                showModal("ğŸ°", `<div style="font-size:5rem; color:var(--red)">x${currentMultiplier}</div>`, false);
                setTimeout(()=>{
                    closeModal();
                    openQuiz();
                }, 1500);
            } else {
                currentMultiplier = 1;
                openQuiz();
            }
        }

        function openQuiz() {
            state = 'QUIZ'; safeBroadcast();
            currentQ = getNextQuestion();
            let pts = currentBaseScore * currentMultiplier;
            let html = `<h3 style="color:#666">æœ¬é¡Œåƒ¹å€¼: ${pts} åˆ† ${currentMultiplier>1?`(x${currentMultiplier})`:''}</h3><h2 style="color:#333">${currentQ.q}</h2><div style="text-align:left">`;
            currentQ.o.forEach((o, i) => {
                html += `<div class="opt-row" onclick="checkAns(${i}, this)">${String.fromCharCode(65+i)}. ${o}</div>`;
            });
            html += `</div><button id="next-btn" onclick="finishQuiz(this)">ä¸‹ä¸€ä½ (è€å¸«è«‹æŒ‰æˆ‘)</button>`;
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }

        function checkAns(ans, el) {
            let rows = document.querySelectorAll('.opt-row');
            let target = el || rows[ans];
            if(!target) return;
            if(document.getElementById('next-btn').style.display === 'block') return;

            let points = currentBaseScore * currentMultiplier;
            if(ans === currentQ.a) {
                target.classList.add('correct'); players[turn].s += points; playSfx('win');
            } else {
                target.classList.add('wrong'); rows[currentQ.a].classList.add('correct'); players[turn].s -= points; playSfx('fail');
            }
            document.getElementById('next-btn').style.display = 'block';
        }

        function showModal(t, m, btn, cb) {
            document.getElementById('modal-content').innerHTML = `<h1>${t}</h1><p>${m}</p>${btn?`<button class="btn" style="background:var(--blue); color:white; width:100%; padding:10px;" id="ok-btn">ç¢ºå®š</button>`:''}`;
            document.getElementById('modal').style.display = 'flex';
            if(btn) document.getElementById('ok-btn').onclick = function() { 
                this.disabled = true;
                document.getElementById('modal').style.display = 'none'; 
                if(cb) cb(); 
            };
        }
        
        // åªè² è²¬é—œé–‰ï¼Œä¸è§¸ç™¼ä¸‹ä¸€æ­¥
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function victory(n) {
            confetti();
            // æ’è¡Œæ¦œé‚è¼¯
            let sorted = [...players].sort((a,b)=>b.s - a.s);
            let html = `<h1>ğŸ† éŠæˆ²çµæŸï¼</h1><h2>æ­å–œ ${n} æŠµé”çµ‚é»ï¼</h2>
            <div style="text-align:left; margin-top:20px;">
            ${sorted.map((p,i)=>`<div class="rank-row" style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;font-size:1.5rem;"><span>${i+1}. ${p.n}</span><b>${p.s} åˆ†</b></div>`).join('')}
            </div>`;
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }
        
        function nextTurn() { 
            if(isSwitchingTurn) return;
            isSwitchingTurn = true;
            updateHUD(); 
            turn = (turn + 1) % 4; 
            state = 'IDLE'; 
            highlightTurn(); 
            safeBroadcast(); 
            setTimeout(() => { isSwitchingTurn = false; }, 2000);
        }
        
        function updateHUD() { for(let i=0; i<4; i++) document.getElementById(`s${i}`).innerText = players[i].s; }
    </script>
</body>
</html>