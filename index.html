<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜åˆ†å­æ´¾å° (é˜²å¡æ­»ç‰ˆ)</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    
    <style>
        /* === ğŸ¨ é¢¨æ ¼è¨­å®š === */
        :root {
            --bg-color: #E0F7FA;
            --red: #FF6B6B;   /* ç¬¬ä¸€çµ„ */
            --blue: #4D96FF;  /* ç¬¬äºŒçµ„ */
            --green: #6BCB77; /* ç¬¬ä¸‰çµ„ */
            --yellow: #FFD93D;/* ç¬¬äº”çµ„ */
            --text-color: #444;
        }

        body {
            font-family: 'Varela Round', sans-serif; margin: 0; background-color: var(--bg-color);
            background-image: radial-gradient(#B2EBF2 15%, transparent 16%), radial-gradient(#B2EBF2 15%, transparent 16%);
            background-size: 60px 60px; background-position: 0 0, 30px 30px;
            color: var(--text-color); overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }

        .btn {
            border: none; outline: none; cursor: pointer; font-family: 'Varela Round', sans-serif; font-weight: bold;
            border-radius: 20px; transition: all 0.1s; box-shadow: 0 6px 0 rgba(0,0,0,0.2);
            text-transform: uppercase; display: flex; align-items: center; justify-content: center; user-select: none;
        }
        .btn:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.2); }

        /* 1. èµ·å§‹é  */
        #start-screen {
            position: absolute; width: 100%; height: 100%; z-index: 100;
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .logo {
            background: white; padding: 20px 40px; border-radius: 30px;
            font-size: 3rem; color: var(--blue); box-shadow: 0 10px 20px rgba(0,0,0,0.2); transform: rotate(-3deg);
            margin-bottom: 20px; text-align: center;
        }
        
        .role-btn {
            width: 80%; max-width: 300px; padding: 20px; font-size: 1.5rem; color: white;
            border-radius: 20px; box-shadow: 0 8px 0 rgba(0,0,0,0.2);
        }
        .input-group {
            display: flex; gap: 10px; width: 80%; max-width: 300px;
        }
        #room-input {
            flex: 1; padding: 15px; border-radius: 15px; border: none; font-size: 1.5rem; text-align: center;
            outline: none; box-shadow: 0 4px 0 rgba(0,0,0,0.1); font-weight: bold; color: #555;
        }

        /* é€£ç·šè¨Šæ¯ */
        #conn-msg {
            background: rgba(255,255,255,0.95); color: var(--blue); padding: 30px; border-radius: 20px;
            font-size: 1.5rem; font-weight: bold; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            display: none; flex-direction: column; align-items: center; gap: 15px; z-index: 200;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 400px;
        }

        /* 2. é›»è…¦ç«¯ä»‹é¢ */
        #teacher-ui { display: none; width: 100%; height: 100%; flex-direction: column; position: relative; }
        
        /* è€å¸«ç­‰å¾…å¤§å»³ (Lobby) */
        #host-lobby {
            position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .room-code-display { font-size: 6rem; font-weight: bold; color: var(--yellow); letter-spacing: 5px; margin: 20px 0; text-shadow: 0 0 20px rgba(255, 217, 61, 0.5); }
        .lobby-info { font-size: 1.5rem; margin-bottom: 40px; color: #ddd; }

        .hud {
            height: 12%; display: flex; justify-content: center; gap: 20px; align-items: center;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 0 10px;
        }
        .score-card {
            background: white; padding: 8px 20px; border-radius: 50px; font-size: 1.2rem; 
            display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 0 #ddd; border: 3px solid transparent; transition: 0.3s;
        }
        .score-card.active { transform: scale(1.15) translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-color: currentColor;}

        .board-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 10px; position: relative; }
        .board {
            display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(5, 1fr);
            gap: 5px; width: 95%; height: 85%; max-width: 1400px;
        }

        /* æ ¼å­ */
        .cell {
            background: white; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.2rem; font-weight: bold; color: #ddd; box-shadow: 0 4px 0 #cbd5e1; position: relative; border: 2px solid #ecf0f1;
        }
        .cell.Start { background: #FFD3B6; color: #ff6b6b; border: none;}
        .cell.Finish { background: #FFD93D; color: #d35400; border: 3px solid #ff9f43;}
        
        /* æ£‹å­ */
        .token {
            width: 40px; height: 40px; border-radius: 50%; position: absolute; z-index: 10;
            background: white; border: 3px solid white; box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer;
        }
        .token:hover { transform: scale(1.2); filter: brightness(1.1); }
        .token:active { transform: scale(0.9); }

        /* 3. æ‰‹æ©Ÿç«¯ä»‹é¢ */
        #student-ui { display: none; width: 100%; height: 100%; flex-direction: column; background: #f0f2f5; }
        .mobile-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        .team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        
        .pad-msg { font-size: 2rem; color: #333; margin-bottom: 30px; font-weight: bold; text-align:center;}
        .big-action-btn { width: 250px; height: 250px; border-radius: 50%; font-size: 3rem; background: var(--yellow); color: #8a6d0b; box-shadow: 0 15px 0 #d4b106; }
        .big-action-btn:active { transform: translateY(15px); box-shadow: 0 0 0 #d4b106; }
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .ans-btn { height: 80px; font-size: 1.5rem; color: white; border-radius: 20px; }

        /* å½ˆçª— */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal-card { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: bounceIn 0.4s; max-height: 90vh; overflow-y: auto;}
        @keyframes bounceIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        .opt-row { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 15px; text-align: left; font-size: 1.2rem; border: 3px solid transparent; cursor: pointer; transition: background 0.2s; }
        .opt-row:hover { background: #e3f2fd; } 
        .opt-row.correct { background: #e8f5e9; border-color: var(--green); color: var(--green); font-weight: bold;}
        .opt-row.wrong { background: #ffebee; border-color: var(--red); color: var(--red); }
        
        /* é™·å®³é¸æ“‡ */
        .target-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .target-btn { padding: 20px; font-size: 1.2rem; color: white; border-radius: 15px; }
        
        /* é€£ç·šç‹€æ…‹å°æ¨™ç±¤ */
        .room-info-badge { position: fixed; bottom: 10px; right: 10px; background:white; padding:5px 15px; border-radius:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); font-weight: bold; color:var(--blue); z-index: 300; font-size: 0.9rem;}

        /* Debug Log (é¡¯ç¤ºåœ¨å·¦ä¸Šè§’) */
        #debug-log {
            position: fixed; top: 0; left: 0; width: 50%; max-height: 200px; overflow-y:auto; 
            background: rgba(0,0,0,0.7); color: #0f0; font-size: 12px; padding: 5px; 
            z-index: 9999; pointer-events: none; text-align: left; font-family: monospace;
        }
    </style>
</head>
<body>

    <div id="debug-log">Log: åˆå§‹åŒ–å®Œæˆ...</div>

    <div id="start-screen">
        <div class="logo">ğŸ§ª é«˜åˆ†å­æ´¾å°</div>
        
        <button class="btn role-btn" style="background:var(--blue);" onclick="startTeacher()">
            ğŸ’» æˆ‘æ˜¯é›»è…¦ (Host)
        </button>
        
        <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.5); width: 80%;"></div>

        <div class="input-group">
            <input type="tel" id="room-input" placeholder="è¼¸å…¥æˆ¿é–“è™Ÿç¢¼" maxlength="4">
        </div>
        <button class="btn role-btn" style="background:white; color:var(--blue);" onclick="startStudent()">
            ğŸ“± æ‰‹æ©ŸåŠ å…¥
        </button>
        
        <button class="btn" style="background:rgba(0,0,0,0.2); color:white; font-size:0.9rem; margin-top:20px; padding:10px 20px;" onclick="startOffline()">
            âš ï¸ å–®æ©Ÿç‰ˆ (å…é€£ç·š)
        </button>
    </div>

    <div id="conn-msg">
        <div style="font-size:3rem">ğŸ”„</div>
        <div>é€£ç·šä¸­...</div>
        <div style="font-size: 0.9rem; color:#888" id="conn-detail">æ­£åœ¨å°‹æ‰¾æˆ¿é–“</div>
    </div>

    <div id="teacher-ui">
        <div id="host-lobby">
            <h2 style="margin:0; opacity:0.8;">è«‹å­¸ç”Ÿè¼¸å…¥æˆ¿é–“è™Ÿç¢¼</h2>
            <div id="lobby-code" class="room-code-display">----</div>
            <div class="lobby-info" id="lobby-status">ç›®å‰é€£ç·šäººæ•¸: 0</div>
            
            <button class="btn" style="background:var(--green); color:white; padding: 20px 60px; font-size: 2rem; box-shadow: 0 10px 0 #4da559;" onclick="closeLobby()">
                ğŸš€ é–‹å§‹éŠæˆ²
            </button>
        </div>

        <div class="hud">
            <div id="card-0" class="score-card" style="color:var(--red)"><span>ğŸ¯ ç¬¬ä¸€çµ„</span> <span id="s0">0</span></div>
            <div id="card-1" class="score-card" style="color:var(--blue)"><span>ğŸ³ ç¬¬äºŒçµ„</span> <span id="s1">0</span></div>
            <div id="card-2" class="score-card" style="color:var(--green)"><span>ğŸ¸ ç¬¬ä¸‰çµ„</span> <span id="s2">0</span></div>
            <div id="card-3" class="score-card" style="color:var(--yellow)"><span>ğŸ¦ ç¬¬äº”çµ„</span> <span id="s3">0</span></div>
        </div>
        <div class="board-container"><div class="board" id="board"></div></div>
        <div class="room-info-badge" id="host-room-info">æˆ¿é–“: ---</div>
    </div>

    <div id="student-ui">
        <div id="team-select" class="mobile-center">
            <h2 style="color:var(--blue); margin-top:0;">è«‹é¸æ“‡çµ„åˆ¥</h2>
            <div class="team-grid">
                <button class="btn" style="background:var(--red); color:white; padding:30px;" onclick="joinGame(0)">ğŸ¯ ç¬¬ä¸€çµ„</button>
                <button class="btn" style="background:var(--blue); color:white; padding:30px;" onclick="joinGame(1)">ğŸ³ ç¬¬äºŒçµ„</button>
                <button class="btn" style="background:var(--green); color:white; padding:30px;" onclick="joinGame(2)">ğŸ¸ ç¬¬ä¸‰çµ„</button>
                <button class="btn" style="background:var(--yellow); color:black; padding:30px;" onclick="joinGame(3)">ğŸ¦ ç¬¬äº”çµ„</button>
            </div>
        </div>
        <div id="pad-screen" class="mobile-center" style="display:none;">
            <div id="pad-msg" class="pad-msg">ç­‰å¾…ä¸­...</div>
            <div id="pad-dice" style="display:none;"><button class="btn big-action-btn" onclick="sendCmd('ROLL')">ğŸ²</button></div>
            <div id="pad-quiz" style="display:none; width:100%; justify-content:center;">
                <div class="ans-grid">
                    <button class="btn ans-btn" style="background:var(--red)" onclick="sendCmd('ANS',0)">A</button>
                    <button class="btn ans-btn" style="background:var(--blue)" onclick="sendCmd('ANS',1)">B</button>
                    <button class="btn ans-btn" style="background:var(--green)" onclick="sendCmd('ANS',2)">C</button>
                    <button class="btn ans-btn" style="background:var(--yellow); color:black" onclick="sendCmd('ANS',3)">D</button>
                </div>
            </div>
            <div id="pad-target" style="display:none; width:100%; justify-content:center;">
                <div class="ans-grid">
                    <button class="btn ans-btn" style="background:var(--red)" onclick="sendCmd('TARGET',0)">ä¸€</button>
                    <button class="btn ans-btn" style="background:var(--blue)" onclick="sendCmd('TARGET',1)">äºŒ</button>
                    <button class="btn ans-btn" style="background:var(--green)" onclick="sendCmd('TARGET',2)">ä¸‰</button>
                    <button class="btn ans-btn" style="background:var(--yellow); color:black" onclick="sendCmd('TARGET',3)">äº”</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal-mask"><div class="modal-card"><div id="modal-content"></div></div></div>

    <script>
        // === æ ¸å¿ƒè¨­å®š ===
        const APP_PREFIX = "poly-party-2025-"; 
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        // é¡Œåº« (ç°¡åŒ–ç‰ˆ)
        const questions = [
            {q:"1.é«˜åˆ†å­çš„åˆ†å­çµæ§‹ä¸€èˆ¬æ˜¯ï¼Ÿ", o:["å¾ˆå°åŸå­", "é•·éˆç‹€", "é‡‘å±¬æ’åˆ—", "æ°£é«”åˆ†å­"], a:1},
            {q:"2.ä¸‹åˆ—ä½•è€…æ˜¯ã€Œç†±å›ºæ€§å¡‘è† ã€ï¼Ÿ", o:["è† å¸¶", "ä¿éº—é¾", "é…šé†›æ¨¹è„‚", "å¯¶ç‰¹ç“¶"], a:2},
            {q:"3.æœ€å¸¸æ‹¿ä¾†åšã€Œé€æ˜è–„è†œã€ï¼Ÿ", o:["PE", "PS", "PP", "PVC"], a:3},
            {q:"4.å¯ä»¥è‡ªç„¶åˆ†è§£çš„é«˜åˆ†å­ï¼Ÿ", o:["PLA", "PS", "PVC", "PE"], a:0},
            {q:"5.ä¸‹åˆ—å“ªé …æ˜¯å¤©ç„¶é«˜åˆ†å­ï¼Ÿ", o:["è›‹ç™½è³ª", "ç»ç’ƒ", "çŸ³é ­", "æ°£é«”"], a:0}
        ];

        let peer, conn, myTeam = -1, turn = 0, state = "IDLE", currentQ = null;
        let connections = [];
        let players = [
            {n:"ç¬¬ä¸€çµ„", c:"var(--red)", p:0, s:0}, {n:"ç¬¬äºŒçµ„", c:"var(--blue)", p:0, s:0},
            {n:"ç¬¬ä¸‰çµ„", c:"var(--green)", p:0, s:0}, {n:"ç¬¬äº”çµ„", c:"var(--yellow)", p:0, s:0}
        ];
        const mapSize = 50; const cols = 10;
        let mapCells = [];
        let lastReceivedState = {turn: 0, state: 'IDLE'}; 

        // å…¨å±€éŒ¯èª¤æ•æ‰ (æœƒåœ¨è¢å¹•ä¸Šé¡¯ç¤ºç´…å­—)
        window.onerror = function(msg, url, line) {
            log(`âŒ ERROR: ${msg} (Line ${line})`);
            return false;
        };

        // === åˆå§‹åŒ– ===
        window.onload = function() { 
            try {
                initMap(); 
                renderBoard(); 
                highlightTurn();
            } catch(e) { log("Init Failed: " + e); }
        };

        function vibe(p) { if(navigator.vibrate) navigator.vibrate(p); }
        function log(msg) { 
            let d = document.getElementById('debug-log');
            d.innerHTML = `<div>${msg}</div>` + d.innerHTML; 
            console.log(msg); 
        }

        function initMap() {
            mapCells = new Array(mapSize).fill("Q");
            mapCells[0] = "Start"; mapCells[mapSize-1] = "Finish";
            const sps = [{t:"Steal", c:5}, {t:"Swap", c:5}, {t:"Good", c:6}, {t:"Bad", c:6}];
            sps.forEach(sp => {
                for(let i=0; i<sp.c; i++) {
                    let r; do { r = Math.floor(Math.random()*(mapSize-2))+1; } while(mapCells[r] !== "Q");
                    mapCells[r] = sp.t;
                }
            });
        }

        // === é›»è…¦ç«¯ (Host) ===
        function startTeacher() {
            const roomCode = Math.floor(1000 + Math.random() * 9000);
            const peerId = APP_PREFIX + roomCode;

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('teacher-ui').style.display = 'flex';
            
            document.getElementById('lobby-code').innerText = roomCode;
            document.getElementById('host-room-info').innerText = `æˆ¿é–“: ${roomCode}`;
            log("HOST: æ­£åœ¨å»ºç«‹ Peer...");

            try {
                peer = new Peer(peerId, peerConfig);
                
                peer.on('open', (id) => {
                    log(`HOST: æˆ¿é–“å·²å»ºç«‹ ${roomCode}`);
                });
                
                peer.on('error', e => {
                    log("HOST Error: " + e.type);
                    alert("é€£ç·šç³»çµ±éŒ¯èª¤: " + e.type);
                });
                
                peer.on('connection', c => {
                    // æ¸…ç†èˆŠçš„ç„¡æ•ˆé€£ç·š
                    connections = connections.filter(con => con.open);
                    connections.push(c);
                    log(`HOST: æ–°é€£ç·š! ç¸½æ•¸: ${connections.length}`);
                    document.getElementById('lobby-status').innerText = `ç›®å‰é€£ç·šäººæ•¸: ${connections.length}`;
                    
                    setTimeout(() => { if(c.open) c.send({type:'STATE', turn:turn, state:state}); }, 500);

                    c.on('data', d => {
                        log(`HOST: æ”¶åˆ°æŒ‡ä»¤ ${d.cmd} from Team ${d.team}`);
                        if(d.team !== turn) {
                            log(`HOST: ç„¡è¦– (é ${d.team} å›åˆ)`);
                            return;
                        }
                        if(d.cmd === 'ROLL' && state === 'IDLE') rollDice();
                        if(d.cmd === 'ANS' && state === 'QUIZ') checkAns(d.val);
                        if(d.cmd === 'TARGET' && state === 'SELECT_TARGET') executeAction(d.val);
                    });
                });
            } catch(e) { alert("ç€è¦½å™¨ä¸æ”¯æ´ WebRTC"); }
        }

        function closeLobby() {
            document.getElementById('host-lobby').style.display = 'none';
            log("HOST: éŠæˆ²é–‹å§‹");
            safeBroadcast();
        }

        // === æ‰‹æ©Ÿç«¯ (Client) ===
        function startStudent() {
            const code = document.getElementById('room-input').value;
            if(!code || code.length !== 4) { alert("è«‹è¼¸å…¥ 4 ä½æ•¸æˆ¿é–“è™Ÿï¼"); return; }
            const hostId = APP_PREFIX + code;
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('conn-msg').style.display = 'flex';
            document.getElementById('conn-detail').innerText = `æ­£åœ¨å°‹æ‰¾æˆ¿é–“ ${code}...`;
            log(`CLIENT: é€£ç·šåˆ° ${code}...`);

            let connTimeout = setTimeout(() => {
                alert("é€£ç·šè¶…æ™‚ï¼å»ºè­°ä½¿ç”¨æ‰‹æ©Ÿç†±é»ã€‚");
                location.reload();
            }, 8000);
            
            try {
                peer = new Peer(peerConfig); 
                peer.on('open', () => {
                    conn = peer.connect(hostId, {reliable: true});
                    conn.on('open', () => {
                        clearTimeout(connTimeout);
                        log("CLIENT: é€£ç·šæˆåŠŸï¼");
                        document.getElementById('conn-msg').style.display = 'none';
                        document.getElementById('student-ui').style.display = 'flex';
                    });
                    conn.on('data', d => {
                        lastReceivedState = d;
                        updatePad(d);
                    });
                    conn.on('error', (err) => log("Conn Error: " + err));
                    conn.on('close', () => { alert("èˆ‡é›»è…¦æ–·ç·š"); location.reload(); });
                });
                peer.on('error', (err) => {
                    clearTimeout(connTimeout);
                    log("Peer Error: " + err.type);
                    alert("é€£ç·šå¤±æ•— (Error: " + err.type + ")");
                    location.reload();
                });
            } catch(e) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); location.reload(); }
        }

        function startOffline() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('teacher-ui').style.display = 'flex';
            document.getElementById('host-lobby').style.display = 'none';
            document.getElementById('host-room-info').innerText = "å–®æ©Ÿæ¨¡å¼";
            log("Offline Mode Started");
        }

        // === éŠæˆ²é‚è¼¯ ===
        function joinGame(t) {
            myTeam = t;
            document.getElementById('team-select').style.display = 'none';
            document.getElementById('pad-screen').style.display = 'flex';
            if(lastReceivedState) updatePad(lastReceivedState);
            log(`CLIENT: åŠ å…¥éšŠä¼ ${players[t].n}`);
        }
        function sendCmd(cmd, val) { 
            if(conn && conn.open) { 
                conn.send({cmd, val, team:myTeam}); 
                vibe(50); 
                log(`CLIENT: ç™¼é€ ${cmd}`);
            }
        }

        function updatePad(data) {
            let isMyTurn = (data.turn === myTeam);
            let status = document.getElementById('pad-msg');
            document.getElementById('pad-dice').style.display = 'none';
            document.getElementById('pad-quiz').style.display = 'none';
            document.getElementById('pad-target').style.display = 'none';
            
            if(isMyTurn) {
                status.style.color = players[myTeam].c;
                if(data.state === 'IDLE') {
                    status.innerText = "ğŸ‘‰ è¼ªåˆ°ä½ äº†ï¼"; document.getElementById('pad-dice').style.display = 'flex'; vibe([100,50,100]);
                } else if (data.state === 'QUIZ') {
                    status.innerText = "ğŸ‘‰ è«‹ä½œç­”ï¼"; document.getElementById('pad-quiz').style.display = 'flex';
                } else if (data.state === 'SELECT_TARGET') {
                    status.innerText = "ğŸ‘‰ é¸æ“‡ç›®æ¨™ï¼"; document.getElementById('pad-target').style.display = 'flex';
                } else status.innerText = "çœ‹å¤§è¢å¹•...";
            } else {
                status.style.color = "#888"; status.innerText = `ç­‰å¾… ${players[data.turn].n}...`;
            }
        }

        function renderBoard() {
            const b = document.getElementById('board');
            if(!b) { log("âŒ Board not found!"); return; }
            b.innerHTML = ''; // Clear first

            for(let i=0; i<mapSize; i++) {
                let d = document.createElement('div');
                d.className = `cell ${mapCells[i]}`;
                if(mapCells[i]==='Start') d.innerText = "ğŸš€";
                else if(mapCells[i]==='Finish') d.innerText = "ğŸ†";
                else d.innerText = i+1;
                let r = Math.floor(i/cols)+1; let c = (i%cols)+1;
                if(r%2===0) c = (cols+1)-c;
                d.style.gridRow=r; d.style.gridColumn=c; d.id=`c-${i}`;
                b.appendChild(d);
            }
            players.forEach((p,i) => {
                let t = document.createElement('div');
                t.className = 'token'; t.innerText = ["ğŸ¯","ğŸ³","ğŸ¸","ğŸ¦"][i]; 
                t.style.color=p.c; t.style.borderColor=p.c; t.id=`t-${i}`;
                t.onclick = () => { 
                    if(state==='IDLE' && turn===i) {
                         if(confirm(`å¹« ${p.n} æ“²éª°å­ï¼Ÿ`)) rollDice(); 
                    } else if (turn !== i) {
                        alert("é‚„æ²’è¼ªåˆ°é€™ä¸€çµ„å–”ï¼");
                    }
                };
                updateTokenPos(i, 0); 
                // Don't append here, updateTokenPos handles it
            });
        }
        
        function updateTokenPos(pid, idx) {
            try {
                let cell = document.getElementById(`c-${idx}`);
                let token = document.getElementById(`t-${pid}`);
                // å¦‚æœ Token é‚„æ²’å»ºç«‹ï¼Œå°±å»ºç«‹ä¸€å€‹
                if(!token) {
                    let p = players[pid];
                    token = document.createElement('div');
                    token.className = 'token'; 
                    token.innerText = ["ğŸ¯","ğŸ³","ğŸ¸","ğŸ¦"][pid]; 
                    token.style.color=p.c; token.style.borderColor=p.c; token.id=`t-${pid}`;
                }
                if(cell) {
                    cell.appendChild(token);
                } else {
                    log(`âŒ Error: Cell ${idx} not found!`);
                }
            } catch(e) { log("UpdateToken Error: " + e); }
        }
        
        function highlightTurn() {
            for(let i=0; i<4; i++) document.getElementById(`card-${i}`).classList.remove('active');
            document.getElementById(`card-${turn}`).classList.add('active');
        }

        // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šè§£è€¦å‹•ç•«èˆ‡å»£æ’­ â˜…â˜…â˜…
        function rollDice() {
            log("HOST: æ“²éª°å­ Start");
            state = 'MOVING';
            
            // 1. å…ˆåšã€Œä¸æœƒéŒ¯ã€çš„äº‹ï¼šè·‘å‹•ç•«
            setTimeout(() => {
                let steps = Math.floor(Math.random()*6)+1;
                log(`HOST: éª°å‡º ${steps}`);
                
                let p = players[turn];
                let c = 0;
                let t = setInterval(()=>{
                    p.p++;
                    if(p.p >= mapSize-1) {
                        p.p = mapSize-1; clearInterval(t); updateTokenPos(turn, p.p);
                        victory(p.n); return;
                    }
                    updateTokenPos(turn, p.p); c++;
                    if(c >= steps) { clearInterval(t); checkEvent(p.p); }
                }, 300);
            }, 50);

            // 2. å†åšã€Œå¯èƒ½æœƒéŒ¯ã€çš„äº‹ï¼šç¶²è·¯å»£æ’­
            safeBroadcast();
        }

        // å®‰å…¨å»£æ’­å‡½æ•¸ (å°±ç®—ç¶²è·¯æ›äº†ä¹Ÿä¸æœƒè®“éŠæˆ²å´©æ½°)
        function safeBroadcast() {
            try {
                if(connections.length > 0) {
                    connections.forEach(c => {
                        if(c.open) c.send({type:'STATE', turn:turn, state:state});
                    });
                }
            } catch(e) {
                log("âš ï¸ Broadcast Warning: " + e);
            }
        }

        function checkEvent(pos) {
            let t = mapCells[pos];
            if(t==='Q') openQuiz();
            else if(t==='Good') showModal("å¥½é‹", "ğŸ’ åŠ  20 åˆ†ï¼", true, ()=>{players[turn].s+=20; nextTurn();});
            else if(t==='Bad') showModal("å„é‹", "ğŸ’£ æ‰£ 10 åˆ†ï¼", true, ()=>{players[turn].s-=10; nextTurn();});
            else if(t==='Steal' || t==='Swap') {
                state = 'SELECT_TARGET'; safeBroadcast();
                // é¡¯ç¤ºä»£é¸ä»‹é¢
                let html = `<h1>è«‹é¸æ“‡ç›®æ¨™</h1><p>å­¸ç”Ÿæ‰‹æ©Ÿé¸ï¼Œæˆ–è€å¸«ä»£é¸ï¼š</p><div class="target-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">`;
                players.forEach((p,i) => {
                    if(i!==turn) html += `<button class="btn" style="background:${p.c}; color:white; padding:15px;" onclick="executeAction(${i}, '${t}')">${p.n}</button>`;
                });
                html += `</div>`;
                document.getElementById('modal-content').innerHTML = html;
                document.getElementById('modal').style.display='flex';
            }
            else nextTurn();
        }

        function executeAction(tIdx, action) {
            if(!action) {
                let type = mapCells[players[turn].p];
                action = type==='Steal'?'Steal':'Swap';
            }
            document.getElementById('modal').style.display='none';
            if(action==='Steal') {
                let amt = 20; if(players[tIdx].s < 20) amt = players[tIdx].s;
                players[tIdx].s -= amt; players[turn].s += amt;
                alert(`æ¶èµ° ${players[tIdx].n} ${amt} åˆ†ï¼`);
            } else {
                let tmp = players[turn].p; players[turn].p = players[tIdx].p; players[tIdx].p = tmp;
                updateTokenPos(turn, players[turn].p); updateTokenPos(tIdx, players[tIdx].p);
                alert(`èˆ‡ ${players[tIdx].n} äº¤æ›ä½ç½®ï¼`);
            }
            nextTurn();
        }

        function openQuiz() {
            state = 'QUIZ'; safeBroadcast();
            currentQ = questions[Math.floor(Math.random()*questions.length)];
            let html = `<h2 style="color:#333">${currentQ.q}</h2><div style="text-align:left">`;
            currentQ.o.forEach((o, i) => {
                html += `<div class="opt-row" onclick="checkAns(${i}, this)">${String.fromCharCode(65+i)}. ${o}</div>`;
            });
            html += `</div><button class="btn" style="background:#333; color:white; width:100%; padding:10px; margin-top:10px; display:none;" id="next-btn" onclick="closeModal()">ä¸‹ä¸€ä½</button>`;
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }

        function checkAns(ans, el) {
            let rows = document.querySelectorAll('.opt-row');
            let target = el || rows[ans];
            if(!target) return;
            if(ans === currentQ.a) {
                target.classList.add('correct'); players[turn].s += 10;
            } else {
                target.classList.add('wrong'); rows[currentQ.a].classList.add('correct');
            }
            document.getElementById('next-btn').style.display = 'block';
        }

        function showModal(t, m, btn, cb) {
            document.getElementById('modal-content').innerHTML = `<h1>${t}</h1><p>${m}</p>${btn?`<button class="btn" style="background:var(--blue); color:white; width:100%; padding:10px;" id="ok-btn">ç¢ºå®š</button>`:''}`;
            document.getElementById('modal').style.display = 'flex';
            if(btn) document.getElementById('ok-btn').onclick = () => { closeModal(); cb(); };
        }

        function victory(n) { confetti(); showModal("å† è»", `ğŸ† æ­å–œ ${n} ç²å‹ï¼`, false); }
        function closeModal() { document.getElementById('modal').style.display = 'none'; nextTurn(); }
        function nextTurn() { updateHUD(); turn = (turn + 1) % 4; state = 'IDLE'; highlightTurn(); safeBroadcast(); }
        function updateHUD() { for(let i=0; i<4; i++) document.getElementById(`s${i}`).innerText = players[i].s; }
    </script>
</body>
</html>